
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Photo Guide</title>
    <style>
        /* CSS Variables for themes */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --header-height: 60px;
        }

        [data-theme="dark"] {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --bg-tertiary: #495057;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
            --border-color: #495057;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Compact Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Filters Menu (Left) */
        .filters-menu {
            position: relative;
        }

        .filters-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .filters-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        .filters-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 350px;
            z-index: 1001;
            display: none;
            padding: 1rem;
            margin-top: 0.25rem;
        }

        .filters-dropdown.show {
            display: block;
        }

        .filters-section {
            margin-bottom: 1rem;
        }

        .filters-section:last-child {
            margin-bottom: 0;
        }

        .filters-section-title {
            font-size: 0.875rem;
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .filters-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Settings Menu (Right) */
        .settings-menu {
            position: relative;
        }

        .settings-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .settings-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1001;
            display: none;
            margin-top: 0.25rem;
        }

        .settings-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }

        .dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 0.25rem 0;
        }

        /* Light Info Button */
        .light-info-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .light-info-btn:hover {
            background-color: var(--accent-hover);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            padding-top: 1rem;
        }

        .content-area {
            flex: 1;
            display: flex;
            gap: 1rem;
        }

        .locations-list {
            flex: 1;
            max-height: calc(100vh - var(--header-height) - 2rem);
            overflow-y: auto;
        }

        .map-container {
            width: 400px;
            height: calc(100vh - var(--header-height) - 2rem);
            position: sticky;
            top: calc(var(--header-height) + 1rem);
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 250px;
            max-width: 800px;
            max-height: 80vh;
        }

        .map-container:hover {
            cursor: nw-resize;
        }

        .resize-handle {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: linear-gradient(-45deg, 
                transparent 0%, transparent 25%, 
                var(--text-muted) 25%, var(--text-muted) 30%, 
                transparent 30%, transparent 45%, 
                var(--text-muted) 45%, var(--text-muted) 50%, 
                transparent 50%, transparent 65%, 
                var(--text-muted) 65%, var(--text-muted) 70%, 
                transparent 70%);
            cursor: nw-resize;
            z-index: 10;
            opacity: 0.6;
            border-radius: 0 0 6px 0;
            transition: opacity 0.2s;
        }

        .resize-handle:hover {
            opacity: 1;
            background: linear-gradient(-45deg, 
                transparent 0%, transparent 25%, 
                var(--accent-color) 25%, var(--accent-color) 30%, 
                transparent 30%, transparent 45%, 
                var(--accent-color) 45%, var(--accent-color) 50%, 
                transparent 50%, transparent 65%, 
                var(--accent-color) 65%, var(--accent-color) 70%, 
                transparent 70%);
        }

        .map-container.resizing {
            transition: none;
        }

        .map-container.resizing #map {
            pointer-events: none;
        }

        /* Light Information Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: var(--bg-secondary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .light-panel {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .light-panel:last-child {
            margin-bottom: 0;
        }

        .light-panel h3 {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .light-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .light-time {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .light-time span:first-child {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .light-time span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Location Cards */
        .location-section {
            margin-bottom: 2rem;
        }

        .section-header {
            background-color: var(--bg-secondary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .location-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .location-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 1rem;
            cursor: pointer;
            user-select: none;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .card-title h4 {
            flex: 1;
            color: var(--text-primary);
        }

        .rank-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .block-badge {
            background-color: var(--info-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .card-summary {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .card-content {
            display: none;
            padding: 0 1rem 1rem;
        }

        .card-content.expanded {
            display: block;
        }

        .card-row {
            display: flex;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .card-row-label {
            min-width: 100px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .card-row-value {
            flex: 1;
            color: var(--text-primary);
        }

        .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        /* New Card Sections Styling */
        .card-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .card-section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-section-title svg {
            color: var(--accent-color);
            flex-shrink: 0;
        }

        /* Micro Pins Styling */
        .micro-pins {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .micro-pin-item {
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .micro-pin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .micro-pin-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .micro-pin-info {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .micro-pin-bearing {
            background-color: var(--accent-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .micro-pin-distance {
            background-color: var(--info-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .micro-pin-detail {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Photography Tips Styling */
        .pins-list {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .pin-item {
            padding-left: 1rem;
            border-left: 3px solid var(--accent-color);
        }

        .pin-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .pin-detail {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Shot List Styling */
        .shots-list {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .shot-item {
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .shot-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .shot-detail {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .form-control {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* Map Tabs */
        .map-tabs {
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .map-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .map-tab:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .map-tab.active {
            background-color: var(--accent-color);
            color: white;
        }

        .map-tab:first-child {
            border-top-left-radius: 6px;
        }

        .map-tab:last-child {
            border-top-right-radius: 6px;
        }

        #map {
            width: 100%;
            height: calc(100% - 45px);
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 0 0.75rem;
            }

            .header-title {
                font-size: 1.125rem;
            }

            .main-content {
                flex-direction: column;
                padding: 0.75rem;
            }

            .content-area {
                flex-direction: column;
            }

            .map-container {
                width: 100%;
                height: 300px;
                position: static;
            }

            .filters-dropdown,
            .settings-dropdown {
                position: fixed;
                top: var(--header-height);
                left: 0.75rem;
                right: 0.75rem;
                min-width: unset;
            }

            .settings-dropdown {
                left: auto;
                right: 0.75rem;
                width: 200px;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }

        /* Theme-specific adjustments */
        [data-theme="dark"] .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Animation for dropdowns */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filters-dropdown.show,
        .settings-dropdown.show {
            animation: fadeIn 0.15s ease-out;
        }

        /* Search input styling */
        #searchInput {
            min-width: 200px;
        }

        /* Rank sliders styling */
        input[type="range"] {
            width: 60px;
        }

        #rankMinValue,
        #rankMaxValue {
            font-weight: bold;
            min-width: 15px;
            text-align: center;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">NYC Photo Guide</h1>
                
                <!-- Filters Menu -->
                <div class="filters-menu">
                    <button class="filters-toggle" id="filtersToggle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"></polygon>
                        </svg>
                        Filters
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </button>
                    <div class="filters-dropdown" id="filtersDropdown">
                        <div class="filters-section">
                            <div class="filters-section-title">Date Settings</div>
                            <div class="filters-row">
                                <div class="control-group">
                                    <label for="dayA">Day A:</label>
                                    <input type="date" id="dayA" class="form-control" value="2025-10-03">
                                </div>
                                <div class="control-group">
                                    <label for="dayB">Day B:</label>
                                    <input type="date" id="dayB" class="form-control" value="2025-10-04">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filters-section">
                            <div class="filters-section-title">Time & Day Filters</div>
                            <div class="filters-row">
                                <div class="control-group">
                                    <label><input type="checkbox" id="showFriSat" checked> Fri/Sat</label>
                                </div>
                            </div>
                            <div class="filters-row">
                                <div class="control-group">
                                    <label><input type="checkbox" id="showMorning" checked> Morning</label>
                                    <label><input type="checkbox" id="showAfternoon" checked> Afternoon</label>
                                    <label><input type="checkbox" id="showEvening" checked> Evening</label>
                                    <label><input type="checkbox" id="showNight" checked> Night</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filters-section">
                            <div class="filters-section-title">Rank Range</div>
                            <div class="filters-row">
                                <div class="control-group">
                                    <label for="rankRange">Min:</label>
                                    <input type="range" id="rankMin" min="1" max="5" value="1" class="form-control">
                                    <span id="rankMinValue">1</span>
                                </div>
                                <div class="control-group">
                                    <label for="rankRange">Max:</label>
                                    <input type="range" id="rankMax" min="1" max="5" value="5" class="form-control">
                                    <span id="rankMaxValue">5</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filters-section">
                            <div class="filters-section-title">Search</div>
                            <div class="filters-row">
                                <input type="text" id="searchInput" placeholder="Search locations..." class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <!-- Light Information Button -->
                <button class="light-info-btn" id="lightInfoBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    Light Info
                </button>
                
                <!-- Settings Menu -->
                <div class="settings-menu">
                    <button class="settings-toggle" id="settingsToggle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="m19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <div class="settings-dropdown" id="settingsDropdown">
                        <button class="dropdown-item" id="expandAll">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="17,11 21,7 17,3"></polyline>
                                <path d="M21,7L3,7"></path>
                                <polyline points="7,21 3,17 7,13"></polyline>
                                <path d="m3,17 18,0"></path>
                            </svg>
                            Expand All
                        </button>
                        <button class="dropdown-item" id="collapseAll">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="11,17 7,21 3,17"></polyline>
                                <path d="M7,21L7,3"></path>
                                <polyline points="21,7 17,3 13,7"></polyline>
                                <path d="m17,3 0,18"></path>
                            </svg>
                            Collapse All
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="exportCSV">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                            </svg>
                            Export CSV
                        </button>
                        <button class="dropdown-item" id="exportKML">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                            </svg>
                            Export KML
                        </button>
                        <button class="dropdown-item" id="exportJSON">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                            </svg>
                            Export JSON
                        </button>
                        <button class="dropdown-item" id="importJSON">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                                <path d="m12,11 0,6"></path>
                                <path d="m9,14 3,-3 3,3"></path>
                            </svg>
                            Import JSON
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="themeToggle">
                            <span id="themeIcon">ðŸŒ™</span>
                            <span id="themeText">Dark Mode</span>
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="clearAll" style="color: var(--danger-color);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            </svg>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="content-area">
                <section class="locations-list" id="locationsList">
                    <!-- Location cards will be populated here -->
                </section>

                <aside class="map-container">
                    <div class="map-tabs">
                        <div class="map-tab active" id="googleTab">Google Maps</div>
                        <div class="map-tab" id="leafletTab">Leaflet (Offline)</div>
                    </div>
                    <div id="map"></div>
                    <div class="resize-handle"></div>
                </aside>
            </div>
        </main>
    </div>

    <!-- Light Information Modal -->
    <div class="modal-overlay" id="lightModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Light & Moon Information</h2>
                <button class="modal-close" id="modalClose">Ã—</button>
            </div>
            <div class="modal-body" id="lightModalBody">
                <!-- Light panels will be populated here -->
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" class="hidden">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- External Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>

    <script type="module">
        // Application Configuration
        const CONFIG = {
            GOOGLE_MAPS_API_KEY: 'AIzaSyDsq2ztFeFfmgqiRIZZtK5R7aCVGF66-80',
            NOAA_TIDES_STATION: '8518750', // The Battery
            DEFAULT_CENTER: { lat: 40.7128, lng: -73.9960 }, // NYC
            DEFAULT_ZOOM: 12,
            PLACES_PHOTO_LIMIT: 12
        };

        // Location Data
        const LOCATIONS_DATA = [
            {
                "id": "dumbo_washington_water_manhattan_bridge_keyhole",
                "name": "DUMBO â€” Washington & Water (Manhattan Bridge Keyhole)",
                "day": "2025-10-03",
                "block": "Morning",
                "rank": 1,
                "bearing": "NNE toward Manhattan Bridge/ESB",
                "whyNow": "Arrive preâ€‘dawn; classic ESB-in-arch alignment.",
                "gear": "24â€“70mm; CPL/ND",
                "settings": "Arrive 30â€“60 min before sunrise; handheld 1/250s+ @ f/5.6â€“8, ISO 100â€“400.",
                "activeAnchor": 0,
                "anchors": [
                    {
                        "label": "Main view",
                        "lat": 40.7034225,
                        "lon": -73.9893714
                    }
                ],
                "micro": [
                    {
                        "title": "Centerline",
                        "r": 0.0,
                        "bearing": 22.5,
                        "dir": "",
                        "detail": "Main alignment from anchor."
                    },
                    {
                        "title": "Stepâ€‘back",
                        "r": 10.0,
                        "bearing": 22.5,
                        "dir": "",
                        "detail": "Step back ~10 m; arrow still toward subject."
                    },
                    {
                        "title": "Corner curb",
                        "r": 22.0,
                        "bearing": 22.5,
                        "dir": "",
                        "detail": "Diagonal curb vantage; arrow toward subject."
                    }
                ],
                "pins": [
                    {
                        "title": "Parking gap watch",
                        "detail": "Scan for a temporary gap to remove parked cars; be ready to shoot quickly."
                    },
                    {
                        "title": "Reflections after wash",
                        "detail": "Street or lawn irrigation leaves sheenâ€”use CPL to control glare."
                    },
                    {
                        "title": "Taxi or jogger streaks",
                        "detail": "If traffic begins, try 1/8â€“1/2s for motion streaks."
                    }
                ],
                "shots": [
                    {
                        "title": "Establishing wide (16â€“24mm)",
                        "detail": "Include context and sky color; keep verticals straight."
                    },
                    {
                        "title": "Low angle leading lines",
                        "detail": "Camera close to ground; emphasize texture or rails."
                    },
                    {
                        "title": "Human scale",
                        "detail": "Single figure walking/running; time the stride."
                    },
                    {
                        "title": "Compressed crop (50/70mm)",
                        "detail": "Use longer end for a clean graphic frame; crop if needed."
                    },
                    {
                        "title": "Detail cutaway",
                        "detail": "Reflections, signage, patterns that summarize place."
                    }
                ]
            },
            {
                "id": "pebble_beach_empire_fulton_ferry",
                "name": "Pebble Beach / Empireâ€“Fulton Ferry",
                "day": "2025-10-03",
                "block": "Morning",
                "rank": 2,
                "bearing": "WSW toward Lower Manhattan",
                "whyNow": "Rising tide likely; long exposures for water smoothing.",
                "gear": "16â€“24mm; 3â€“6â€‘stop ND; tripod",
                "settings": "Arrive 30â€“60 min before sunrise; handheld 1/250s+ @ f/5.6â€“8, ISO 100â€“400.",
                "activeAnchor": 0,
                "anchors": [
                    {
                        "label": "Main view",
                        "lat": 40.7041667,
                        "lon": -73.9922222
                    }
                ],
                "micro": [
                    {
                        "title": "Centerline",
                        "r": 0.0,
                        "bearing": 247.5,
                        "dir": "",
                        "detail": "Main alignment from anchor."
                    },
                    {
                        "title": "Stepâ€‘back",
                        "r": 10.0,
                        "bearing": 247.5,
                        "dir": "",
                        "detail": "Step back ~10 m; arrow still toward subject."
                    },
                    {
                        "title": "Corner curb",
                        "r": 22.0,
                        "bearing": 247.5,
                        "dir": "",
                        "detail": "Diagonal curb vantage; arrow toward subject."
                    }
                ],
                "pins": [
                    {
                        "title": "Tide timing",
                        "detail": "Check NOAA Battery data; rising tide smooths water texture."
                    },
                    {
                        "title": "Wind direction",
                        "detail": "SW wind creates ripples; calm conditions better for long exposures."
                    }
                ],
                "shots": [
                    {
                        "title": "Ultra-wide context",
                        "detail": "14â€“16mm to capture full Manhattan span and foreground rocks."
                    },
                    {
                        "title": "Long exposure smooth",
                        "detail": "30sâ€“2min with ND filters; silky water against sharp buildings."
                    }
                ]
            },
            {
                "id": "brooklyn_heights_promenade",
                "name": "Brooklyn Heights Promenade",
                "day": "2025-10-03",
                "block": "Morning",
                "rank": 3,
                "bearing": "WSW across East River",
                "whyNow": "Tele compression of skyline; benches and trees for layers.",
                "gear": "24â€“70mm (at 70mm) or 50mm (crop); 24â€“70mm",
                "settings": "Arrive 30â€“60 min before sunrise; handheld 1/250s+ @ f/5.6â€“8, ISO 100â€“400.",
                "activeAnchor": 0,
                "anchors": [
                    {
                        "label": "Main view",
                        "lat": 40.6969,
                        "lon": -73.9969
                    }
                ],
                "micro": [
                    {
                        "title": "Centerline",
                        "r": 0.0,
                        "bearing": 247.5,
                        "dir": "",
                        "detail": "Main alignment from promenade center."
                    },
                    {
                        "title": "North section",
                        "r": 50.0,
                        "bearing": 270.0,
                        "dir": "",
                        "detail": "Walk north for different skyline angles."
                    }
                ],
                "pins": [
                    {
                        "title": "Bench positioning",
                        "detail": "Use benches as foreground elements; vary height by standing on them."
                    },
                    {
                        "title": "Tree framing",
                        "detail": "Seasonal foliage can frame shots; winter gives cleaner skyline view."
                    }
                ],
                "shots": [
                    {
                        "title": "Compressed skyline",
                        "detail": "70mm+ to stack buildings; shallow DOF isolates layers."
                    },
                    {
                        "title": "Foreground bench",
                        "detail": "Include promenade elements for human scale and depth."
                    }
                ]
            }];

        class PhotoGuideApp {
            constructor() {
                this.locations = LOCATIONS_DATA;
                this.filteredLocations = [...this.locations];
                this.expandedCards = new Set();
                
                this.filters = {
                    dayA: '2025-10-03',
                    dayB: '2025-10-04',
                    showFriSat: true,
                    showMorning: true,
                    showAfternoon: true,
                    showEvening: true,
                    showNight: true,
                    rankMin: 1,
                    rankMax: 5,
                    searchText: ''
                };

                this.currentMapProvider = 'google';
                this.map = null;
                this.leafletMap = null;
                this.markers = [];

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initTheme();
                this.loadGoogleMapsAPI();
                this.applyFilters();
                this.render();
                this.setupMapResizeObserver();
            }

            setupEventListeners() {
                // Dropdown toggles
                const filtersToggle = document.getElementById('filtersToggle');
                const filtersDropdown = document.getElementById('filtersDropdown');
                const settingsToggle = document.getElementById('settingsToggle');
                const settingsDropdown = document.getElementById('settingsDropdown');

                filtersToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    filtersDropdown.classList.toggle('show');
                    settingsDropdown.classList.remove('show');
                });

                settingsToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('show');
                    filtersDropdown.classList.remove('show');
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', () => {
                    filtersDropdown.classList.remove('show');
                    settingsDropdown.classList.remove('show');
                });

                // Prevent closing when clicking inside dropdowns
                filtersDropdown.addEventListener('click', (e) => e.stopPropagation());
                settingsDropdown.addEventListener('click', (e) => e.stopPropagation());

                // Light information modal
                const lightInfoBtn = document.getElementById('lightInfoBtn');
                const lightModal = document.getElementById('lightModal');
                const modalClose = document.getElementById('modalClose');

                lightInfoBtn.addEventListener('click', () => {
                    this.renderLightModal();
                    lightModal.classList.add('show');
                });

                modalClose.addEventListener('click', () => {
                    lightModal.classList.remove('show');
                });

                lightModal.addEventListener('click', (e) => {
                    if (e.target === lightModal) {
                        lightModal.classList.remove('show');
                    }
                });

                // Filter controls
                document.getElementById('dayA').addEventListener('change', (e) => {
                    this.filters.dayA = e.target.value;
                    this.applyFilters();
                    this.render();
                });

                document.getElementById('dayB').addEventListener('change', (e) => {
                    this.filters.dayB = e.target.value;
                    this.applyFilters();
                    this.render();
                });

                // Time filter checkboxes
                ['showFriSat', 'showMorning', 'showAfternoon', 'showEvening', 'showNight'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        this.filters[id] = e.target.checked;
                        this.applyFilters();
                        this.render();
                    });
                });

                // Rank sliders
                const rankMin = document.getElementById('rankMin');
                const rankMax = document.getElementById('rankMax');
                const rankMinValue = document.getElementById('rankMinValue');
                const rankMaxValue = document.getElementById('rankMaxValue');

                rankMin.addEventListener('input', (e) => {
                    this.filters.rankMin = parseInt(e.target.value);
                    rankMinValue.textContent = e.target.value;
                    if (this.filters.rankMin > this.filters.rankMax) {
                        this.filters.rankMax = this.filters.rankMin;
                        rankMax.value = this.filters.rankMin;
                        rankMaxValue.textContent = this.filters.rankMin;
                    }
                    this.applyFilters();
                    this.render();
                });

                rankMax.addEventListener('input', (e) => {
                    this.filters.rankMax = parseInt(e.target.value);
                    rankMaxValue.textContent = e.target.value;
                    if (this.filters.rankMax < this.filters.rankMin) {
                        this.filters.rankMin = this.filters.rankMax;
                        rankMin.value = this.filters.rankMax;
                        rankMinValue.textContent = this.filters.rankMax;
                    }
                    this.applyFilters();
                    this.render();
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.searchText = e.target.value;
                    this.applyFilters();
                    this.render();
                });

                // Settings menu actions
                document.getElementById('expandAll').addEventListener('click', () => {
                    this.expandAllCards();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('collapseAll').addEventListener('click', () => {
                    this.collapseAllCards();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('exportCSV').addEventListener('click', () => {
                    this.exportToCSV();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('exportKML').addEventListener('click', () => {
                    this.exportToKML();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('exportJSON').addEventListener('click', () => {
                    this.exportToJSON();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('importJSON').addEventListener('click', () => {
                    document.getElementById('importFile').click();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('importFile').addEventListener('change', (e) => {
                    this.importFromJSON(e.target.files[0]);
                });

                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                    settingsDropdown.classList.remove('show');
                });

                document.getElementById('clearAll').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                        this.clearAllData();
                    }
                    settingsDropdown.classList.remove('show');
                });

                // Map tab switching
                document.getElementById('googleTab').addEventListener('click', () => {
                    this.switchMapProvider('google');
                });

                document.getElementById('leafletTab').addEventListener('click', () => {
                    this.switchMapProvider('leaflet');
                });
            }

            initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme);
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                
                if (theme === 'dark') {
                    themeIcon.textContent = 'â˜€ï¸';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'ðŸŒ™';
                    themeText.textContent = 'Dark Mode';
                }
                
                localStorage.setItem('theme', theme);
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                this.setTheme(currentTheme === 'light' ? 'dark' : 'light');
            }

            renderLightModal() {
                const container = document.getElementById('lightModalBody');
                if (!container) return;

                const days = [
                    { date: this.filters.dayA, label: 'Day A' },
                    { date: this.filters.dayB, label: 'Day B' }
                ];

                let html = '';
                days.forEach(day => {
                    const lightInfo = this.calculateLightTimes(new Date(day.date));
                    html += `
                        <div class="light-panel">
                            <h3>${day.label} (${day.date})</h3>
                            <div class="light-info">
                                <div class="light-time">
                                    <span>Civil Dawn:</span>
                                    <span>${lightInfo.civilDawn}</span>
                                </div>
                                <div class="light-time">
                                    <span>Sunrise:</span>
                                    <span>${lightInfo.sunrise}</span>
                                </div>
                                <div class="light-time">
                                    <span>Sunset:</span>
                                    <span>${lightInfo.sunset}</span>
                                </div>
                                <div class="light-time">
                                    <span>Civil Dusk:</span>
                                    <span>${lightInfo.civilDusk}</span>
                                </div>
                                <div class="light-time">
                                    <span>Moonrise:</span>
                                    <span>${lightInfo.moonrise}</span>
                                </div>
                                <div class="light-time">
                                    <span>Moonset:</span>
                                    <span>${lightInfo.moonset}</span>
                                </div>
                                <div class="light-time">
                                    <span>Moon Phase:</span>
                                    <span>${lightInfo.moonPhase}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            calculateLightTimes(date) {
                const times = SunCalc.getTimes(date, CONFIG.DEFAULT_CENTER.lat, CONFIG.DEFAULT_CENTER.lng);
                const moonTimes = SunCalc.getMoonTimes(date, CONFIG.DEFAULT_CENTER.lat, CONFIG.DEFAULT_CENTER.lng);
                const moonIllumination = SunCalc.getMoonIllumination(date);

                return {
                    civilDawn: this.formatTime(times.dawn),
                    sunrise: this.formatTime(times.sunrise),
                    sunset: this.formatTime(times.sunset),
                    civilDusk: this.formatTime(times.dusk),
                    moonrise: moonTimes.rise ? this.formatTime(moonTimes.rise) : 'No rise',
                    moonset: moonTimes.set ? this.formatTime(moonTimes.set) : 'No set',
                    moonPhase: Math.round(moonIllumination.fraction * 100)
                };
            }

            formatTime(date) {
                if (!date || !(date instanceof Date) || isNaN(date)) return 'N/A';
                return date.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            applyFilters() {
                this.filteredLocations = this.locations.filter(location => {
                    // Day filter
                    const locationDate = location.day;
                    if (locationDate !== this.filters.dayA && locationDate !== this.filters.dayB) {
                        return false;
                    }

                    // Day of week filter
                    if (!this.filters.showFriSat) {
                        const date = new Date(locationDate);
                        const dayOfWeek = date.getDay();
                        if (dayOfWeek === 5 || dayOfWeek === 6) { // Friday or Saturday
                            return false;
                        }
                    }

                    // Block filter
                    const block = location.block.toLowerCase();
                    if (!this.filters.showMorning && block === 'morning') return false;
                    if (!this.filters.showAfternoon && block === 'afternoon') return false;
                    if (!this.filters.showEvening && block === 'evening') return false;
                    if (!this.filters.showNight && block === 'night') return false;

                    // Rank filter
                    if (location.rank < this.filters.rankMin || location.rank > this.filters.rankMax) {
                        return false;
                    }

                    // Search filter
                    if (this.filters.searchText) {
                        const searchLower = this.filters.searchText.toLowerCase();
                        const nameMatch = location.name.toLowerCase().includes(searchLower);
                        const bearingMatch = location.bearing.toLowerCase().includes(searchLower);
                        const whyNowMatch = location.whyNow.toLowerCase().includes(searchLower);
                        
                        if (!nameMatch && !bearingMatch && !whyNowMatch) {
                            return false;
                        }
                    }

                    return true;
                });
            }

            render() {
                this.renderLocations();
                this.renderMap();
            }

            renderLocations() {
                const container = document.getElementById('locationsList');
                if (!container) return;

                // Group locations by day
                const groupedByDay = {};
                this.filteredLocations.forEach(location => {
                    if (!groupedByDay[location.day]) {
                        groupedByDay[location.day] = {};
                    }
                    if (!groupedByDay[location.day][location.block]) {
                        groupedByDay[location.day][location.block] = [];
                    }
                    groupedByDay[location.day][location.block].push(location);
                });

                let html = '';
                const dayLabels = {
                    [this.filters.dayA]: 'Day A',
                    [this.filters.dayB]: 'Day B'
                };

                Object.keys(groupedByDay).sort().forEach(day => {
                    const dayLabel = dayLabels[day] || day;
                    html += `<div class="location-section">
                        <div class="section-header">${dayLabel} (${day})</div>`;

                    const blocks = ['Morning', 'Afternoon', 'Evening', 'Night'];
                    blocks.forEach(block => {
                        if (groupedByDay[day][block]) {
                            groupedByDay[day][block]
                                .sort((a, b) => a.rank - b.rank)
                                .forEach(location => {
                                    const isExpanded = this.expandedCards.has(location.id);
                                    const activeAnchor = location.anchors[location.activeAnchor];

                                    html += `
                                        <div class="location-card">
                                            <div class="card-header" onclick="window.app.toggleCard('${location.id}')">
                                                <div class="card-title">
                                                    <h4>${location.name}</h4>
                                                    <span class="rank-badge">Rank ${location.rank}</span>
                                                    <span class="block-badge">${location.block}</span>
                                                </div>
                                                <div class="card-summary">${location.whyNow}</div>
                                            </div>
                                            <div class="card-content ${isExpanded ? 'expanded' : ''}">
                                                <div class="card-row">
                                                    <span class="card-row-label">Bearing:</span>
                                                    <span class="card-row-value">${location.bearing}</span>
                                                </div>
                                                <div class="card-row">
                                                    <span class="card-row-label">Gear:</span>
                                                    <span class="card-row-value">${location.gear}</span>
                                                </div>
                                                <div class="card-row">
                                                    <span class="card-row-label">Settings:</span>
                                                    <span class="card-row-value">${location.settings}</span>
                                                </div>
                                                
                                                <div class="card-actions">
                                                    ${location.anchors.map((anchor, index) => 
                                                        `<button class="btn ${index === location.activeAnchor ? 'btn-primary' : ''}" 
                                                                onclick="window.app.setActiveAnchor('${location.id}', ${index})">
                                                            ${anchor.label}
                                                        </button>`
                                                    ).join('')}
                                                    <button class="btn" onclick="window.app.centerMapOnLocation('${location.id}')">
                                                        Show on Map
                                                    </button>
                                                </div>

                                                ${location.micro && location.micro.length > 0 ? `
                                                <div class="card-section">
                                                    <h5 class="card-section-title">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <circle cx="12" cy="12" r="3"></circle>
                                                            <line x1="8.5" y1="8.5" x2="7" y2="7"></line>
                                                            <line x1="15.5" y1="8.5" x2="17" y2="7"></line>
                                                            <line x1="15.5" y1="15.5" x2="17" y2="17"></line>
                                                            <line x1="8.5" y1="15.5" x2="7" y2="17"></line>
                                                        </svg>
                                                        Micro Pins
                                                    </h5>
                                                    <div class="micro-pins">
                                                        ${location.micro.map(micro => `
                                                            <div class="micro-pin-item">
                                                                <div class="micro-pin-header">
                                                                    <span class="micro-pin-title">${micro.title}</span>
                                                                    <div class="micro-pin-info">
                                                                        <span class="micro-pin-bearing">â†— ${micro.bearing}Â°</span>
                                                                        ${micro.r > 0 ? `<span class="micro-pin-distance">${micro.r}m</span>` : ''}
                                                                    </div>
                                                                </div>
                                                                <div class="micro-pin-detail">${micro.detail}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                ` : ''}

                                                ${location.pins && location.pins.length > 0 ? `
                                                <div class="card-section">
                                                    <h5 class="card-section-title">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                                            <circle cx="12" cy="12" r="4"></circle>
                                                        </svg>
                                                        Photography Tips
                                                    </h5>
                                                    <div class="pins-list">
                                                        ${location.pins.map(pin => `
                                                            <div class="pin-item">
                                                                <div class="pin-title">${pin.title}</div>
                                                                <div class="pin-detail">${pin.detail}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                ` : ''}

                                                ${location.shots && location.shots.length > 0 ? `
                                                <div class="card-section">
                                                    <h5 class="card-section-title">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                                            <circle cx="12" cy="13" r="4"></circle>
                                                        </svg>
                                                        Shot List
                                                    </h5>
                                                    <div class="shots-list">
                                                        ${location.shots.map(shot => `
                                                            <div class="shot-item">
                                                                <div class="shot-title">${shot.title}</div>
                                                                <div class="shot-detail">${shot.detail}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                });
                        }
                    });
                    html += `</div>`;
                });

                container.innerHTML = html;
            }

            toggleCard(locationId) {
                if (this.expandedCards.has(locationId)) {
                    this.expandedCards.delete(locationId);
                } else {
                    this.expandedCards.add(locationId);
                }
                this.render();
            }

            expandAllCards() {
                this.filteredLocations.forEach(location => {
                    this.expandedCards.add(location.id);
                });
                this.render();
            }

            collapseAllCards() {
                this.expandedCards.clear();
                this.render();
            }

            setActiveAnchor(locationId, anchorIndex) {
                const location = this.locations.find(loc => loc.id === locationId);
                if (location) {
                    location.activeAnchor = anchorIndex;
                    this.render();
                }
            }

            centerMapOnLocation(locationId) {
                const location = this.locations.find(loc => loc.id === locationId);
                if (!location) return;

                const activeAnchor = location.anchors[location.activeAnchor];
                const center = { lat: activeAnchor.lat, lng: activeAnchor.lon };

                if (this.currentMapProvider === 'google' && this.map) {
                    this.map.setCenter(center);
                    this.map.setZoom(16);
                } else if (this.currentMapProvider === 'leaflet' && this.leafletMap) {
                    this.leafletMap.setView([center.lat, center.lng], 16);
                }
            }

            // Map functionality
            loadGoogleMapsAPI() {
                if (window.google && window.google.maps) {
                    this.initGoogleMap();
                    return;
                }

                window.initGoogleMap = () => this.initGoogleMap();
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initGoogleMap`;
                script.onerror = () => {
                    console.warn('Google Maps failed to load, switching to Leaflet');
                    this.switchMapProvider('leaflet');
                };
                document.head.appendChild(script);
            }

            initGoogleMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;

                try {
                    this.map = new google.maps.Map(mapElement, {
                        center: CONFIG.DEFAULT_CENTER,
                        zoom: CONFIG.DEFAULT_ZOOM,
                        styles: [
                            {
                                featureType: 'poi',
                                elementType: 'labels.icon',
                                stylers: [{ visibility: 'off' }]
                            }
                        ]
                    });

                    this.renderGoogleMarkers();
                } catch (error) {
                    console.error('Error initializing Google Maps:', error);
                    this.switchMapProvider('leaflet');
                }
            }

            initLeafletMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;

                try {
                    // Clear existing map
                    mapElement.innerHTML = '';
                    
                    this.leafletMap = L.map(mapElement).setView(
                        [CONFIG.DEFAULT_CENTER.lat, CONFIG.DEFAULT_CENTER.lng], 
                        CONFIG.DEFAULT_ZOOM
                    );

                    L.tileLayer('https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Tiled_web_map_numbering.png/320px-Tiled_web_map_numbering.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(this.leafletMap);

                    this.renderLeafletMarkers();
                } catch (error) {
                    console.error('Error initializing Leaflet map:', error);
                }
            }

            renderGoogleMarkers() {
                if (!this.map) return;

                // Clear existing markers
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];

                this.filteredLocations.forEach(location => {
                    const activeAnchor = location.anchors[location.activeAnchor];
                    
                    // Main location marker
                    const mainMarker = new google.maps.Marker({
                        position: { lat: activeAnchor.lat, lng: activeAnchor.lon },
                        map: this.map,
                        title: location.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: this.getColorForBlock(location.block),
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: '#ffffff'
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 8px; max-width: 300px;">
                                <h4 style="margin: 0 0 8px 0; color: #333;">${location.name}</h4>
                                <p style="margin: 4px 0; color: #666;"><strong>Block:</strong> ${location.block}</p>
                                <p style="margin: 4px 0; color: #666;"><strong>Rank:</strong> ${location.rank}</p>
                                <p style="margin: 4px 0; color: #666;"><strong>Bearing:</strong> ${location.bearing}</p>
                                <p style="margin: 4px 0 0 0; color: #555;">${location.whyNow}</p>
                            </div>
                        `
                    });

                    mainMarker.addListener('click', () => {
                        infoWindow.open(this.map, mainMarker);
                    });

                    this.markers.push(mainMarker);

                    // Micro pins using actual bearing and distance data
                    if (location.micro && location.micro.length > 0) {
                        location.micro.forEach((microPin, index) => {
                            const microPos = this.calculateMicroPinPositionFromData(
                                activeAnchor, microPin
                            );
                            
                            const microMarker = new google.maps.Marker({
                                position: microPos,
                                map: this.map,
                                title: `${location.name} - ${microPin.title}`,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 4,
                                    fillColor: '#17a2b8',
                                    fillOpacity: 0.8,
                                    strokeWeight: 1,
                                    strokeColor: '#ffffff'
                                },
                                zIndex: 1000
                            });

                            // Add directional arrow pointing towards the bearing
                            const arrowMarker = new google.maps.Marker({
                                position: microPos,
                                map: this.map,
                                icon: {
                                    path: 'M 0,-2 L 0,2 M 0,0 L 4,-2 M 0,0 L 4,2',
                                    scale: 2,
                                    strokeColor: this.getColorForBlock(location.block),
                                    strokeWeight: 2,
                                    rotation: microPin.bearing || 0
                                },
                                zIndex: 1001
                            });

                            const microInfoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="padding: 8px;">
                                        <h5 style="margin: 0 0 4px 0;">${location.name}</h5>
                                        <p style="margin: 2px 0; color: #666;"><strong>${microPin.title}</strong></p>
                                        <p style="margin: 2px 0; color: #555; font-size: 0.85rem;">Bearing: ${microPin.bearing}Â°</p>
                                        <p style="margin: 2px 0 0 0; color: #555; font-size: 0.85rem;">${microPin.detail}</p>
                                    </div>
                                `
                            });

                            microMarker.addListener('click', (e) => {
                                e.stop();
                                microInfoWindow.open(this.map, microMarker);
                            });

                            this.markers.push(microMarker);
                            this.markers.push(arrowMarker);
                        });
                    }
                });

                // Fit bounds to show all markers
                if (this.markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    this.markers.forEach(marker => bounds.extend(marker.getPosition()));
                    this.map.fitBounds(bounds);
                }
            }

            renderLeafletMarkers() {
                if (!this.leafletMap) return;

                // Clear existing markers
                this.markers.forEach(marker => {
                    if (marker.remove) marker.remove();
                });
                this.markers = [];

                this.filteredLocations.forEach(location => {
                    const activeAnchor = location.anchors[location.activeAnchor];
                    
                    // Main location marker
                    const mainMarker = L.circleMarker([activeAnchor.lat, activeAnchor.lon], {
                        radius: 8,
                        fillColor: this.getColorForBlock(location.block),
                        color: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(this.leafletMap);

                    mainMarker.bindPopup(`
                        <div style="max-width: 300px;">
                            <h4 style="margin: 0 0 8px 0;">${location.name}</h4>
                            <p style="margin: 4px 0;"><strong>Block:</strong> ${location.block}</p>
                            <p style="margin: 4px 0;"><strong>Rank:</strong> ${location.rank}</p>
                            <p style="margin: 4px 0;"><strong>Bearing:</strong> ${location.bearing}</p>
                            <p style="margin: 4px 0 0 0;">${location.whyNow}</p>
                        </div>
                    `);

                    this.markers.push(mainMarker);

                    // Micro pins using actual bearing and distance data
                    if (location.micro && location.micro.length > 0) {
                        location.micro.forEach((microPin, index) => {
                            const microPos = this.calculateMicroPinPositionFromData(
                                activeAnchor, microPin
                            );
                            
                            const microMarker = L.circleMarker([microPos.lat, microPos.lng], {
                                radius: 4,
                                fillColor: '#17a2b8',
                                color: '#ffffff',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(this.leafletMap);

                            // Add directional arrow pointing towards the bearing
                            const arrowIcon = L.divIcon({
                                html: `<div style="transform: rotate(${microPin.bearing}deg); width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 16px; color: ${this.getColorForBlock(location.block)};">â†’</div>`,
                                className: 'arrow-icon',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });

                            const arrowMarker = L.marker([microPos.lat, microPos.lng], {
                                icon: arrowIcon
                            }).addTo(this.leafletMap);

                            microMarker.bindPopup(`
                                <div>
                                    <h5 style="margin: 0 0 4px 0;">${location.name}</h5>
                                    <p style="margin: 2px 0; font-weight: bold;">${microPin.title}</p>
                                    <p style="margin: 2px 0; font-size: 0.85rem;">Bearing: ${microPin.bearing}Â°</p>
                                    <p style="margin: 2px 0 0 0; font-size: 0.85rem;">${microPin.detail}</p>
                                </div>
                            `);

                            this.markers.push(microMarker);
                            this.markers.push(arrowMarker);
                        });
                    }
                });

                // Fit bounds to show all markers
                if (this.markers.length > 0) {
                    const group = new L.featureGroup(this.markers);
                    this.leafletMap.fitBounds(group.getBounds().pad(0.1));
                }
            }

            calculateMicroPinPosition(mainPos, index, totalCount) {
                const offsetDistance = 0.0005; // ~50 meters
                const baseAngle = -60; // Start from upper left
                const angleRange = 120; // Spread across 120 degrees
                
                const angle = baseAngle + (angleRange * index / Math.max(1, totalCount - 1));
                const angleRad = angle * Math.PI / 180;
                
                // Vary the distance slightly
                const distance = offsetDistance * (0.8 + 0.4 * Math.random());
                
                const deltaLat = distance * Math.cos(angleRad);
                const deltaLng = distance * Math.sin(angleRad);
                
                return {
                    lat: mainPos.lat + deltaLat,
                    lng: mainPos.lon + deltaLng
                };
            }

            calculateMicroPinPositionFromData(mainPos, microPin) {
                // Use actual bearing and distance from microPin data
                const bearing = microPin.bearing || 0; // degrees
                let distance = microPin.r || 10; // meters, default 10m if not specified
                
                // Convert distance from meters to approximate lat/lng offset
                // 1 degree latitude â‰ˆ 111,000 meters
                // 1 degree longitude â‰ˆ 111,000 * cos(latitude) meters
                const metersPerDegreeLat = 111000;
                const metersPerDegreeLng = 111000 * Math.cos(mainPos.lat * Math.PI / 180);
                
                // Convert bearing to radians (bearing is measured clockwise from North)
                const bearingRad = (bearing - 90) * Math.PI / 180; // Adjust for coordinate system
                
                // Calculate position offset
                const deltaLat = (distance * Math.sin(bearingRad + Math.PI / 2)) / metersPerDegreeLat;
                const deltaLng = (distance * Math.cos(bearingRad + Math.PI / 2)) / metersPerDegreeLng;
                
                return {
                    lat: mainPos.lat + deltaLat,
                    lng: mainPos.lon + deltaLng
                };
            }

            getColorForBlock(block) {
                const colors = {
                    'Morning': '#ff6b35',
                    'Afternoon': '#f7931e',
                    'Evening': '#a855f7',
                    'Night': '#3b82f6'
                };
                return colors[block] || '#6b7280';
            }

            renderMap() {
                if (this.currentMapProvider === 'google' && this.map) {
                    this.renderGoogleMarkers();
                } else if (this.currentMapProvider === 'leaflet' && this.leafletMap) {
                    this.renderLeafletMarkers();
                }
            }

            switchMapProvider(provider) {
                this.currentMapProvider = provider;
                
                // Update tab appearance
                document.getElementById('googleTab').classList.toggle('active', provider === 'google');
                document.getElementById('leafletTab').classList.toggle('active', provider === 'leaflet');

                if (provider === 'google') {
                    if (!this.map) {
                        this.initGoogleMap();
                    } else {
                        this.renderGoogleMarkers();
                    }
                } else {
                    this.initLeafletMap();
                }
            }

            setupMapResizeObserver() {
                const mapContainer = document.querySelector('.map-container');
                if (!mapContainer || !window.ResizeObserver) return;

                const resizeObserver = new ResizeObserver(() => {
                    // Debounce resize events
                    clearTimeout(this.resizeTimeout);
                    this.resizeTimeout = setTimeout(() => {
                        if (this.currentMapProvider === 'google' && this.map) {
                            google.maps.event.trigger(this.map, 'resize');
                            if (this.markers.length > 0) {
                                const bounds = new google.maps.LatLngBounds();
                                this.markers.forEach(marker => bounds.extend(marker.getPosition()));
                                this.map.fitBounds(bounds);
                            }
                        } else if (this.currentMapProvider === 'leaflet' && this.leafletMap) {
                            this.leafletMap.invalidateSize();
                            if (this.markers.length > 0) {
                                const group = new L.featureGroup(this.markers);
                                this.leafletMap.fitBounds(group.getBounds().pad(0.1));
                            }
                        }
                    }, 250);
                });

                resizeObserver.observe(mapContainer);
            }

            // Export/Import functionality
            exportToCSV() {
                const csvContent = [
                    ['Name', 'Day', 'Block', 'Rank', 'Bearing', 'Why Now', 'Gear', 'Settings', 'Latitude', 'Longitude'].join(','),
                    ...this.filteredLocations.map(location => {
                        const activeAnchor = location.anchors[location.activeAnchor];
                        return [
                            `"${location.name}"`,
                            location.day,
                            location.block,
                            location.rank,
                            `"${location.bearing}"`,
                            `"${location.whyNow}"`,
                            `"${location.gear}"`,
                            `"${location.settings}"`,
                            activeAnchor.lat,
                            activeAnchor.lon
                        ].join(',');
                    })
                ].join('\n');

                this.downloadFile(csvContent, 'nyc-photo-guide.csv', 'text/csv');
            }

            exportToKML() {
                const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>NYC Photo Guide</name>
        <description>Photography locations in NYC</description>
        ${this.filteredLocations.map(location => {
            const activeAnchor = location.anchors[location.activeAnchor];
            return `
        <Placemark>
            <name>${location.name}</name>
            <description><![CDATA[
                <strong>Day:</strong> ${location.day}<br>
                <strong>Block:</strong> ${location.block}<br>
                <strong>Rank:</strong> ${location.rank}<br>
                <strong>Bearing:</strong> ${location.bearing}<br>
                <strong>Why Now:</strong> ${location.whyNow}<br>
                <strong>Gear:</strong> ${location.gear}<br>
                <strong>Settings:</strong> ${location.settings}
            ]]></description>
            <Point>
                <coordinates>${activeAnchor.lon},${activeAnchor.lat},0</coordinates>
            </Point>
        </Placemark>`;
        }).join('')}
    </Document>
</kml>`;

                this.downloadFile(kmlContent, 'nyc-photo-guide.kml', 'application/vnd.google-earth.kml+xml');
            }

            exportToJSON() {
                const jsonContent = JSON.stringify({
                    exportDate: new Date().toISOString(),
                    filters: this.filters,
                    locations: this.filteredLocations
                }, null, 2);

                this.downloadFile(jsonContent, 'nyc-photo-guide.json', 'application/json');
            }

            importFromJSON(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.locations && Array.isArray(data.locations)) {
                            if (confirm('Import new locations? This will replace current data.')) {
                                this.locations = data.locations;
                                
                                if (data.filters) {
                                    this.filters = { ...this.filters, ...data.filters };
                                    this.updateFilterInputs();
                                }
                                
                                this.applyFilters();
                                this.render();
                                alert('Data imported successfully!');
                            }
                        } else {
                            alert('Invalid file format. Please select a valid JSON file.');
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Error importing file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }

            updateFilterInputs() {
                document.getElementById('dayA').value = this.filters.dayA;
                document.getElementById('dayB').value = this.filters.dayB;
                document.getElementById('showFriSat').checked = this.filters.showFriSat;
                document.getElementById('showMorning').checked = this.filters.showMorning;
                document.getElementById('showAfternoon').checked = this.filters.showAfternoon;
                document.getElementById('showEvening').checked = this.filters.showEvening;
                document.getElementById('showNight').checked = this.filters.showNight;
                document.getElementById('rankMin').value = this.filters.rankMin;
                document.getElementById('rankMax').value = this.filters.rankMax;
                document.getElementById('rankMinValue').textContent = this.filters.rankMin;
                document.getElementById('rankMaxValue').textContent = this.filters.rankMax;
                document.getElementById('searchInput').value = this.filters.searchText;
            }

            clearAllData() {
                this.locations = [];
                this.filteredLocations = [];
                this.expandedCards.clear();
                this.render();
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize the application
        window.app = new PhotoGuideApp();
        
        // Make app available globally for onclick handlers
        window.addEventListener('load', () => {
            console.log('NYC Photo Guide loaded successfully');
        });
    </script>
</body>
</html>
