<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYC Photo Guide</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --fg: #f5f7fb;
      --muted: #a7b0c0;
      --card: #151823;
      --accent: #4da3ff;
      --ok: #19c37d;
      --warn: #ffb300;
      --err: #ff5b5b;
      --border: #2a3040;
      --chip: #22283a;
      --chip-fg: #dfe7ff;
      --pill: #26324a;
      --link: #8bc1ff;
      --morning: #ffb84d;
      --afternoon: #4dd2a4;
      --evening: #8a7dff;
      --night: #ff6b9a;
    }
    [data-theme="light"] {
      --bg: #f6f7fb;
      --fg: #10131a;
      --muted: #5b6577;
      --card: #ffffff;
      --accent: #005bd1;
      --ok: #008a5a;
      --warn: #8a6a00;
      --err: #b00000;
      --border: #e1e6ef;
      --chip: #eef2fa;
      --chip-fg: #223040;
      --pill: #e9f1ff;
      --link: #005bd1;
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg); 
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header {
      position: sticky; top: 0; z-index: 500;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .controls { display: grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap: 8px; margin-top: 8px; }
    .controls > * { min-width: 0; }
    .chip {
      background: var(--chip); color: var(--chip-fg);
      border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; display: inline-flex; gap: 8px; align-items: center;
    }
    .btn {
      background: var(--pill); color: var(--fg); border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 8px; cursor: pointer;
    }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; }
    input[type="date"], input[type="text"], input[type="number"], select {
      background: var(--card); color: var(--fg); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; width: 100%;
    }
    input[type="range"] { width: 100%; }
    .container { display: grid; grid-template-columns: 340px 1fr; gap: 12px; padding: 12px; }
    .leftcol { display: flex; flex-direction: column; gap: 12px; }
    .panel {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px;
    }
    .panel h3 { margin: 0 0 8px 0; font-size: 14px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }
    .kv { display: grid; grid-template-columns: auto 1fr; gap: 6px 10px; }
    .kv div.key { color: var(--muted); }
    .map-wrap { position: sticky; top: 72px; height: calc(100vh - 92px); }
    #map-google, #map-leaflet { position: absolute; inset: 0; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    #map-google { display: none; }
    /* Leaflet container placeholder */
    #map-leaflet { display: none; }
    main { grid-column: 1 / -1; }
    .section { margin: 24px 0 8px 0; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .08em; }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px;
    }
    .card h4 { margin: 0 0 6px 0; font-size: 16px; }
    .badges { display: flex; gap: 6px; }
    .badge { border-radius: 6px; padding: 2px 6px; font-size: 12px; border: 1px solid var(--border); background: var(--chip); color: var(--chip-fg); }
    .badge.Morning { background: var(--morning); color: #111; }
    .badge.Afternoon { background: var(--afternoon); color: #111; }
    .badge.Evening { background: var(--evening); }
    .badge.Night { background: var(--night); }
    .summary { color: var(--muted); margin: 6px 0 10px 0; }
    .kvs { display: grid; grid-template-columns: 120px 1fr; gap: 6px 10px; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
    .pillset { display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0; }
    .pill { padding: 4px 8px; border: 1px solid var(--border); border-radius: 999px; background: var(--pill); cursor: pointer; }
    .pill.active { outline: 2px solid var(--accent); }
    details > summary { cursor: pointer; list-style: none; }
    details[open] summary { margin-bottom: 8px; }
    details .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .list { display: grid; gap: 4px; }
    .toast {
      position: fixed; right: 12px; bottom: 12px; z-index: 9999; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.2);
    }
    .hide { display: none !important; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; }
    .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; }
    .ref-grid img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); }
    .sr-only { position: absolute; left: -9999px; top: -9999px; }
    .footer-note { margin: 32px 0; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header aria-label="Controls header">
    <div class="row">
      <div class="title" aria-label="App title">ðŸ“· NYC Photo Guide</div>
      <div class="chip" title="Engine mode">
        <label><input type="radio" name="engine" value="google" id="engine-google" /> Google</label>
        <label style="margin-left:10px"><input type="radio" name="engine" value="leaflet" id="engine-leaflet" /> Leaflet</label>
      </div>
      <button id="themeBtn" class="btn" aria-label="Toggle theme">Theme</button>
    </div>
    <div class="controls" role="group" aria-label="Filters and tools">
      <div class="chip" style="grid-column: span 3;">
        <label>Day A <input type="date" id="dayA"></label>
      </div>
      <div class="chip" style="grid-column: span 3;">
        <label>Day B <input type="date" id="dayB"></label>
      </div>
      <div class="chip" style="grid-column: span 2;">
        <label><input type="checkbox" id="showA" checked> Show A</label>
        <label style="margin-left:10px"><input type="checkbox" id="showB" checked> Show B</label>
      </div>
      <div class="chip" style="grid-column: span 4;">
        <label><input type="checkbox" class="blk" value="Morning" checked> Morning</label>
        <label style="margin-left:10px"><input type="checkbox" class="blk" value="Afternoon" checked> Afternoon</label>
        <label style="margin-left:10px"><input type="checkbox" class="blk" value="Evening" checked> Evening</label>
        <label style="margin-left:10px"><input type="checkbox" class="blk" value="Night" checked> Night</label>
      </div>
      <div class="chip" style="grid-column: span 4;">
        <div id="rankLabel" aria-live="polite">Rank 1â€“5</div>
        <div class="grid-2" style="margin-top:6px">
          <input type="range" id="rankMin" min="1" max="5" value="1" aria-label="Rank min">
          <input type="range" id="rankMax" min="1" max="5" value="5" aria-label="Rank max">
        </div>
      </div>
      <div class="chip" style="grid-column: span 4;">
        <input type="text" id="search" placeholder="Search name/gear/why/pins/shotsâ€¦" aria-label="Search locations">
      </div>
      <div class="chip" style="grid-column: span 4;">
        <button id="expandAll" class="btn">Expand all</button>
        <button id="collapseAll" class="btn">Collapse all</button>
        <button id="exportCSV" class="btn">Export CSV</button>
        <button id="exportKML" class="btn">Export KML</button>
      </div>
      <div class="chip" style="grid-column: span 4;">
        <button id="printBtn" class="btn">Print</button>
        <button id="exportJSON" class="btn">Export JSON</button>
        <label class="btn" for="importJSON">Import JSON</label>
        <input id="importJSON" type="file" accept="application/json" class="sr-only">
      </div>
    </div>
  </header>
  <div class="container">
    <div class="leftcol" aria-live="polite">
      <div class="panel" id="lightA"><h3>Day A â€¢ Light & Moon</h3><div class="kv" id="lightAkv"></div></div>
      <div class="panel" id="lightB"><h3>Day B â€¢ Light & Moon</h3><div class="kv" id="lightBkv"></div></div>
      <div class="panel" id="tides"><h3>Tides â€” The Battery</h3><div class="kv" id="tidesKV"></div></div>
    </div>
    <div class="map-wrap">
      <div id="map-google" role="region" aria-label="Google Map"></div>
      <div id="map-leaflet" role="region" aria-label="Leaflet Map"></div>
    </div>
    <main id="cards" aria-live="polite"></main>
  </div>
  <div id="toast" class="toast hide" role="status" aria-live="polite"></div>
  
<script type="module">
// Base64-embedded modules -> Blob URLs -> import('app')
const B64 = {"app": "Ly8gYXBwLmpzIOKAlCBvcmNoZXN0cmF0ZXMgVUksIGRhdGEsIG1hcHMsIHBhbmVscywgZXhwb3J0cwppbXBvcnQgeyBDT05GSUcgfSBmcm9tICcuL2NvbmZpZy5qcyc7CmltcG9ydCB7IExPQ0FUSU9OUywgcGVyc2lzdEFuY2hvckVkaXQgfSBmcm9tICcuL2RhdGEvbG9jYXRpb25zLmpzJzsKaW1wb3J0IHsgY2FsY1N1blRpbWVzLCBjYWxjTW9vblRpbWVzLCBjYWxjTW9vbklsbHVtaW5hdGlvbiwgZm10VGltZSB9IGZyb20gJy4vbGliL3N1bm1vb24uanMnOwoKbGV0IHN0YXRlID0gewogIGVuZ2luZTogJ2xlYWZsZXQnLAogIGRheUE6ICcnLAogIGRheUI6ICcnLAogIHNob3dBOiB0cnVlLAogIHNob3dCOiB0cnVlLAogIGJsb2NrczogbmV3IFNldChbJ01vcm5pbmcnLCdBZnRlcm5vb24nLCdFdmVuaW5nJywnTmlnaHQnXSksCiAgcmFua01pbjogMSwKICByYW5rTWF4OiA1LAogIHNlYXJjaDogJycsCiAgZGF5TWFwOiB7IEE6ICcnLCBCOiAnJyB9LAp9OwoKbGV0IGVuZ2luZSA9IG51bGw7IC8vIGN1cnJlbnQgbWFwIGVuZ2luZSBpbnN0YW5jZQpsZXQgTXV0YWJsZUxvY2F0aW9ucyA9IExPQ0FUSU9OUy5tYXAoeD0+KHsuLi54fSkpOwoKZnVuY3Rpb24gaW5pdCgpewogIC8vIFRoZW1lCiAgY29uc3Qgc2F2ZWRUaGVtZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdUSEVNRScpIHx8ICdkYXJrJzsKICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJywgc2F2ZWRUaGVtZSk7CgogIC8vIEVuZ2luZSBkZWZhdWx0CiAgY29uc3Qga2V5ID0gQ09ORklHLkdPT0dMRV9NQVBTX0FQSV9LRVk7CiAgc3RhdGUuZW5naW5lID0ga2V5ID8gJ2dvb2dsZScgOiAnbGVhZmxldCc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZ2luZS1nb29nbGUnKS5jaGVja2VkID0gc3RhdGUuZW5naW5lPT09J2dvb2dsZSc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZ2luZS1sZWFmbGV0JykuY2hlY2tlZCA9IHN0YXRlLmVuZ2luZT09PSdsZWFmbGV0JzsKCiAgLy8gRGF5IGRlZmF1bHRzIGZyb20gZGF0YQogIGNvbnN0IGRheXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoTXV0YWJsZUxvY2F0aW9ucy5tYXAobD0+bC5kYXkpKSkuc29ydCgpOwogIHN0YXRlLmRheUEgPSBkYXlzWzBdIHx8ICcyMDI1LTEwLTAzJzsKICBzdGF0ZS5kYXlCID0gZGF5c1sxXSB8fCAnMjAyNS0xMC0wNCc7CiAgc3RhdGUuZGF5TWFwID0geyBBOiBzdGF0ZS5kYXlBLCBCOiBzdGF0ZS5kYXlCIH07CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RheUEnKS52YWx1ZSA9IHN0YXRlLmRheUE7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RheUInKS52YWx1ZSA9IHN0YXRlLmRheUI7CgogIC8vIEJpbmQgY29udHJvbHMKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGhlbWVCdG4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57CiAgICBjb25zdCBjdXIgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJyk7CiAgICBjb25zdCBuZXh0ID0gY3VyPT09J2xpZ2h0JyA/ICdkYXJrJyA6ICdsaWdodCc7CiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXRoZW1lJywgbmV4dCk7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnVEhFTUUnLCBuZXh0KTsKICB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5naW5lLWdvb2dsZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsICgpPT4gc3dpdGNoRW5naW5lKCdnb29nbGUnKSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZ2luZS1sZWFmbGV0JykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKCk9PiBzd2l0Y2hFbmdpbmUoJ2xlYWZsZXQnKSk7CgogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkYXlBJykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZT0+eyBzdGF0ZS5kYXlBID0gZS50YXJnZXQudmFsdWU7IHN0YXRlLmRheU1hcC5BID0gc3RhdGUuZGF5QTsgcGFuZWxzKCk7IHJlbmRlcigpOyB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGF5QicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGU9Pnsgc3RhdGUuZGF5QiA9IGUudGFyZ2V0LnZhbHVlOyBzdGF0ZS5kYXlNYXAuQiA9IHN0YXRlLmRheUI7IHBhbmVscygpOyByZW5kZXIoKTsgfSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Nob3dBJykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZT0+eyBzdGF0ZS5zaG93QSA9IGUudGFyZ2V0LmNoZWNrZWQ7IHJlbmRlcigpOyB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2hvd0InKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBlPT57IHN0YXRlLnNob3dCID0gZS50YXJnZXQuY2hlY2tlZDsgcmVuZGVyKCk7IH0pOwogIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5ibGsnKS5mb3JFYWNoKGNoPT4gY2guYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZT0+ewogICAgaWYoZS50YXJnZXQuY2hlY2tlZCkgc3RhdGUuYmxvY2tzLmFkZChlLnRhcmdldC52YWx1ZSk7IGVsc2Ugc3RhdGUuYmxvY2tzLmRlbGV0ZShlLnRhcmdldC52YWx1ZSk7CiAgICByZW5kZXIoKTsKICB9KSk7CiAgY29uc3QgcmFua01pbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYW5rTWluJyk7CiAgY29uc3QgcmFua01heCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYW5rTWF4Jyk7CiAgY29uc3QgcmFua0xhYmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JhbmtMYWJlbCcpOwogIGZ1bmN0aW9uIHN5bmNSYW5rKCl7CiAgICBsZXQgYSA9ICtyYW5rTWluLnZhbHVlLCBiID0gK3JhbmtNYXgudmFsdWU7CiAgICBpZihhPmIpeyBjb25zdCB0PWE7IGE9YjsgYj10OyByYW5rTWluLnZhbHVlPWE7IHJhbmtNYXgudmFsdWU9YjsgfQogICAgc3RhdGUucmFua01pbiA9IGE7IHN0YXRlLnJhbmtNYXggPSBiOwogICAgcmFua0xhYmVsLnRleHRDb250ZW50ID0gYFJhbmsgJHthfeKAkyR7Yn1gOwogICAgcmVuZGVyKCk7CiAgfQogIHJhbmtNaW4uYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBzeW5jUmFuayk7CiAgcmFua01heC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHN5bmNSYW5rKTsKICBzeW5jUmFuaygpOwoKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VhcmNoJykuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBlPT57IHN0YXRlLnNlYXJjaCA9IGUudGFyZ2V0LnZhbHVlLnRvTG93ZXJDYXNlKCk7IHJlbmRlcigpOyB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhwYW5kQWxsJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+eyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdkZXRhaWxzJykuZm9yRWFjaChkPT4gZC5vcGVuID0gdHJ1ZSk7IH0pOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb2xsYXBzZUFsbCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnZGV0YWlscycpLmZvckVhY2goZD0+IGQub3BlbiA9IGZhbHNlKTsgfSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4cG9ydENTVicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXhwb3J0Q1NWKTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhwb3J0S01MJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBleHBvcnRLTUwpOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleHBvcnRKU09OJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBleHBvcnRKU09OKTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW1wb3J0SlNPTicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGltcG9ydEpTT04pOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmludEJ0bicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PndpbmRvdy5wcmludCgpKTsKCiAgLy8gSW5pdCBtYXAKICBzd2l0Y2hFbmdpbmUoc3RhdGUuZW5naW5lKS50aGVuKCgpPT57CiAgICBwYW5lbHMoKTsKICAgIHJlbmRlcigpOwogIH0pOwp9Cgphc3luYyBmdW5jdGlvbiBzd2l0Y2hFbmdpbmUobW9kZSl7CiAgc3RhdGUuZW5naW5lID0gbW9kZTsKICAvLyBoaWRlIGJvdGggY29udGFpbmVycwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAtZ29vZ2xlJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwLWxlYWZsZXQnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogIC8vIGRpc3Bvc2UgY3VycmVudAogIGVuZ2luZSA9IG51bGw7CiAgaWYobW9kZT09PSdnb29nbGUnKXsKICAgIGNvbnN0IHsgR29vZ2xlRW5naW5lIH0gPSBhd2FpdCBpbXBvcnQoJy4vbWFwLWdvb2dsZS5qcycpOwogICAgZW5naW5lID0gbmV3IEdvb2dsZUVuZ2luZSgnbWFwLWdvb2dsZScpOwogICAgdHJ5ewogICAgICBhd2FpdCBlbmdpbmUuaW5pdCgpOwogICAgfWNhdGNoKGUpewogICAgICB0b2FzdCgnR29vZ2xlIGZhaWxlZDsgZmFsbGluZyBiYWNrIHRvIExlYWZsZXQnKTsKICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VuZ2luZS1sZWFmbGV0JykuY2hlY2tlZCA9IHRydWU7CiAgICAgIHJldHVybiBzd2l0Y2hFbmdpbmUoJ2xlYWZsZXQnKTsKICAgIH0KICB9ZWxzZXsKICAgIGNvbnN0IHsgTGVhZmxldEVuZ2luZSB9ID0gYXdhaXQgaW1wb3J0KCcuL21hcC1sZWFmbGV0LmpzJyk7CiAgICBlbmdpbmUgPSBuZXcgTGVhZmxldEVuZ2luZSgnbWFwLWxlYWZsZXQnKTsKICAgIGF3YWl0IGVuZ2luZS5pbml0KCk7CiAgfQogIHJlbmRlcigpOwp9CgpmdW5jdGlvbiBwYW5lbHMoKXsKICAvLyBMaWdodC9Nb29uIHBhbmVscyBwZXIgc2VsZWN0ZWQgZGF5CiAgcmVuZGVyTGlnaHRQYW5lbCgnQScsIHN0YXRlLmRheUEpOwogIHJlbmRlckxpZ2h0UGFuZWwoJ0InLCBzdGF0ZS5kYXlCKTsKICByZW5kZXJUaWRlcygpOwp9CgpmdW5jdGlvbiByZW5kZXJMaWdodFBhbmVsKGxhYmVsLCBkYXRlU3RyKXsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGxhYmVsPT09J0EnID8gJ2xpZ2h0QWt2JyA6ICdsaWdodEJrdicpOwogIGVsLmlubmVySFRNTD0nJzsKICBpZighZGF0ZVN0cikgcmV0dXJuOwogIGNvbnN0IGQgPSBuZXcgRGF0ZShkYXRlU3RyKydUMTI6MDA6MDAnKTsgLy8gbm9vbiBsb2NhbCBhcHByb3hpbWF0aW9uCiAgY29uc3Qgc3VuID0gY2FsY1N1blRpbWVzKGQpOwogIGNvbnN0IG1vb24gPSBjYWxjTW9vblRpbWVzKGQpOwogIGNvbnN0IGlsbHVtID0gY2FsY01vb25JbGx1bWluYXRpb24oZCk7CiAgY29uc3Qgcm93cyA9IFsKICAgIFsnQ2l2aWwgZGF3bicsIGZtdFRpbWUoc3VuLmNpdmlsRGF3bildLAogICAgWydTdW5yaXNlJywgZm10VGltZShzdW4uc3VucmlzZSldLAogICAgWydTdW5zZXQnLCBmbXRUaW1lKHN1bi5zdW5zZXQpXSwKICAgIFsnQ2l2aWwgZHVzaycsIGZtdFRpbWUoc3VuLmNpdmlsRHVzayldLAogICAgWydNb29ucmlzZScsIGZtdFRpbWUobW9vbi5yaXNlKV0sCiAgICBbJ01vb25zZXQnLCBmbXRUaW1lKG1vb24uc2V0KV0sCiAgICBbJ01vb24gaWxsdW0uJywgKGlsbHVtLmZyYWN0aW9uKjEwMCkudG9GaXhlZCgwKSsnJSddCiAgXTsKICBmb3IoY29uc3QgW2ssdl0gb2Ygcm93cyl7CiAgICBjb25zdCBrZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyBrZC50ZXh0Q29udGVudD1rOyBrZC5jbGFzc05hbWU9J2tleSc7CiAgICBjb25zdCB2ZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOyB2ZC50ZXh0Q29udGVudD12IHx8ICfigJQnOwogICAgZWwuYXBwZW5kQ2hpbGQoa2QpOyBlbC5hcHBlbmRDaGlsZCh2ZCk7CiAgfQp9Cgphc3luYyBmdW5jdGlvbiByZW5kZXJUaWRlcygpewogIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpZGVzS1YnKTsKICBlbC5pbm5lckhUTUwgPSAnJzsKICBjb25zdCBkYXlzID0gW3N0YXRlLmRheUEsIHN0YXRlLmRheUJdLmZpbHRlcihCb29sZWFuKTsKICBmb3IoY29uc3QgZHMgb2YgZGF5cyl7CiAgICBjb25zdCBrdmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsga3ZrLnRleHRDb250ZW50ID0gbmV3IERhdGUoZHMpLnRvRGF0ZVN0cmluZygpOyBrdmsuY2xhc3NOYW1lPSdrZXknOwogICAgY29uc3Qga3Z2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGt2di50ZXh0Q29udGVudCA9ICdMb2FkaW5n4oCmJzsKICAgIGVsLmFwcGVuZENoaWxkKGt2ayk7IGVsLmFwcGVuZENoaWxkKGt2dik7CiAgICB0cnl7CiAgICAgIGNvbnN0IHR4dCA9IGF3YWl0IGZldGNoTm9hYShkcyk7CiAgICAgIGt2di50ZXh0Q29udGVudCA9IHR4dDsKICAgIH1jYXRjaChlKXsKICAgICAga3Z2LmlubmVySFRNTCA9IGBPcGVuIE5PQUEgaGlnaC9sb3dgOyAvLyBncmFjZWZ1bCBmYWxsYmFjawogICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICBhLmhyZWYgPSAnaHR0cHM6Ly90aWRlc2FuZGN1cnJlbnRzLm5vYWEuZ292L25vYWF0aWRlcHJlZGljdGlvbnMuaHRtbD9pZD04NTE4NzUwJzsKICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsgYS5yZWw9J25vb3BlbmVyJzsKICAgICAgYS50ZXh0Q29udGVudCA9ICcgKGxpbmspJzsKICAgICAga3Z2LmFwcGVuZENoaWxkKGEpOwogICAgfQogIH0KfQoKYXN5bmMgZnVuY3Rpb24gZmV0Y2hOb2FhKGRhdGVTdHIpewogIGNvbnN0IGR0ID0gbmV3IERhdGUoZGF0ZVN0cik7CiAgY29uc3QgeSA9IGR0LmdldEZ1bGxZZWFyKCksIG0gPSAoJycrKGR0LmdldE1vbnRoKCkrMSkpLnBhZFN0YXJ0KDIsJzAnKSwgZCA9ICgnJytkdC5nZXREYXRlKCkpLnBhZFN0YXJ0KDIsJzAnKTsKICBjb25zdCBiZWdpbiA9IGAke3l9JHttfSR7ZH1gOwogIGNvbnN0IHVybCA9IGBodHRwczovL2FwaS50aWRlc2FuZGN1cnJlbnRzLm5vYWEuZ292L2FwaS9wcm9kL2RhdGFnZXR0ZXI/cHJvZHVjdD1wcmVkaWN0aW9ucyZiZWdpbl9kYXRlPSR7YmVnaW59JmVuZF9kYXRlPSR7YmVnaW59JmRhdHVtPU1MTFcmc3RhdGlvbj04NTE4NzUwJnRpbWVfem9uZT1sc3RfbGR0JmludGVydmFsPWhpbG8mdW5pdHM9ZW5nbGlzaCZmb3JtYXQ9anNvbmA7CiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsKTsKICBpZighcmVzLm9rKSB0aHJvdyBuZXcgRXJyb3IoJ05PQUEgcmVxdWVzdCBmYWlsZWQnKTsKICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICBjb25zdCBhcnIgPSBkYXRhPy5wcmVkaWN0aW9ucyB8fCBbXTsKICBpZighYXJyLmxlbmd0aCkgcmV0dXJuICfigJQnOwogIC8vIENvbXBvc2UgaGkvbG8gc3VtbWFyeSBsaWtlICJIaSA2OjAzIEFNIC8gTG8gMTI6NDQgUE0gLyBIaSA2OjU3IFBNIC8gTG8gMTowNSBBTSIKICBjb25zdCBwYXJ0cyA9IGFyci5tYXAocD0+IGAke3AudHlwZS50b1VwcGVyQ2FzZSgpfSAke25ldyBJbnRsLkRhdGVUaW1lRm9ybWF0KFtdLCB7aG91cjonMi1kaWdpdCcsbWludXRlOicyLWRpZ2l0J30pLmZvcm1hdChuZXcgRGF0ZShwLnQpKX1gKTsKICByZXR1cm4gcGFydHMuam9pbignIMK3ICcpOwp9CgpmdW5jdGlvbiBmaWx0KGwpewogIC8vIERheSBmaWx0ZXIKICBpZighKCAoc3RhdGUuc2hvd0EgJiYgbC5kYXk9PT1zdGF0ZS5kYXlBKSB8fCAoc3RhdGUuc2hvd0IgJiYgbC5kYXk9PT1zdGF0ZS5kYXlCKSApKSByZXR1cm4gZmFsc2U7CiAgaWYoIXN0YXRlLmJsb2Nrcy5oYXMobC5ibG9jaykpIHJldHVybiBmYWxzZTsKICBpZihsLnJhbms8c3RhdGUucmFua01pbiB8fCBsLnJhbms+c3RhdGUucmFua01heCkgcmV0dXJuIGZhbHNlOwogIGlmKHN0YXRlLnNlYXJjaCl7CiAgICBjb25zdCBoYXkgPSBbbC5uYW1lLGwud2h5Tm93LGwuZ2VhciwobC5waW5zfHxbXSkubWFwKHA9PnAudGl0bGUrJyAnK3AuZGV0YWlsKS5qb2luKCcgJyksKGwuc2hvdHN8fFtdKS5tYXAocz0+cy50aXRsZSsnICcrcy5kZXRhaWwpLmpvaW4oJyAnKV0uam9pbignICcpLnRvTG93ZXJDYXNlKCk7CiAgICBpZighaGF5LmluY2x1ZGVzKHN0YXRlLnNlYXJjaCkpIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIHJlbmRlcigpewogIC8vIEZpbHRlciBhbmQgZ3JvdXAKICBjb25zdCBpdGVtcyA9IE11dGFibGVMb2NhdGlvbnMuZmlsdGVyKGZpbHQpLnNvcnQoKGEsYik9PiBhLnJhbmstYi5yYW5rKTsKICAvLyBSZW5kZXIgbWFya2VycwogIGlmKGVuZ2luZSl7IAogICAgY29uc3QgbG9jc0J5QWN0aXZlID0gaXRlbXMubWFwKHg9Pih7IC4uLngsIGFuY2hvcnM6IHguYW5jaG9ycywgYWN0aXZlQW5jaG9yOiB4LmFjdGl2ZUFuY2hvcnx8MCB9KSk7CiAgICBlbmdpbmUucmVuZGVyKGxvY3NCeUFjdGl2ZSk7IAogIH0KICAvLyBDYXJkcwogIGNvbnN0IGNhcmRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NhcmRzJyk7CiAgY2FyZHMuaW5uZXJIVE1MPScnOwogIGNvbnN0IGdyb3VwcyA9IGdyb3VwQnkoaXRlbXMsIGw9PiBgJHtsLmRheX18JHtsLmJsb2NrfWApOwogIGNvbnN0IG9yZGVyQmxvY2tzID0gWydNb3JuaW5nJywnQWZ0ZXJub29uJywnRXZlbmluZycsJ05pZ2h0J107CiAgY29uc3QgZ3JvdXBLZXlzID0gT2JqZWN0LmtleXMoZ3JvdXBzKS5zb3J0KChhLGIpPT57CiAgICBjb25zdCBbZGEsYmFdID0gYS5zcGxpdCgnfCcpOyBjb25zdCBbZGIsYmJdID0gYi5zcGxpdCgnfCcpOwogICAgY29uc3QgZGNtcCA9IChkYT09PXN0YXRlLmRheUE/MDoxKSAtIChkYj09PXN0YXRlLmRheUE/MDoxKSB8fCAoZGE8ZGI/LTE6ZGE+ZGI/MTowKTsKICAgIGNvbnN0IGJjbXAgPSBvcmRlckJsb2Nrcy5pbmRleE9mKGJhKSAtIG9yZGVyQmxvY2tzLmluZGV4T2YoYmIpOwogICAgcmV0dXJuIGRjbXAgfHwgYmNtcDsKICB9KTsKICBmb3IoY29uc3Qga2V5IG9mIGdyb3VwS2V5cyl7CiAgICBjb25zdCBbZCxiXSA9IGtleS5zcGxpdCgnfCcpOwogICAgY29uc3Qgc2VjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBzZWMuY2xhc3NOYW1lPSdzZWN0aW9uJzsKICAgIGNvbnN0IGRhdGVMYmwgPSBuZXcgRGF0ZShkKS50b0xvY2FsZURhdGVTdHJpbmcodW5kZWZpbmVkLCB7d2Vla2RheTonc2hvcnQnLCBtb250aDonc2hvcnQnLCBkYXk6J251bWVyaWMnfSk7CiAgICBzZWMudGV4dENvbnRlbnQgPSBgJHtkYXRlTGJsfSDigKIgJHtifWA7CiAgICBjYXJkcy5hcHBlbmRDaGlsZChzZWMpOwogICAgZm9yKGNvbnN0IGwgb2YgZ3JvdXBzW2tleV0pewogICAgICBjYXJkcy5hcHBlbmRDaGlsZChjYXJkKGwpKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNhcmQobCl7CiAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgZGl2LmNsYXNzTmFtZT0nY2FyZCc7CiAgZGl2LnNldEF0dHJpYnV0ZSgnZGF0YS1pZCcsIGwuaWQpOwogIGNvbnN0IGJhZGdlcyA9IGA8c3BhbiBjbGFzcz0iYmFkZ2UgJHtsLmJsb2NrfSIgdGl0bGU9IkJsb2NrIj4ke2wuYmxvY2t9PC9zcGFuPjxzcGFuIGNsYXNzPSJiYWRnZSIgdGl0bGU9IlJhbmsiPiMke2wucmFua308L3NwYW4+YDsKICBkaXYuaW5uZXJIVE1MID0gYAogICAgPGg0PiR7bC5uYW1lfTwvaDQ+CiAgICA8ZGl2IGNsYXNzPSJiYWRnZXMiPiR7YmFkZ2VzfTwvZGl2PgogICAgPGRpdiBjbGFzcz0ic3VtbWFyeSI+JHtuZXcgRGF0ZShsLmRheSkudG9EYXRlU3RyaW5nKCl9IOKAoiAke2wuYmxvY2t9IOKAoiAke2wuYmVhcmluZ308L2Rpdj4KICAgIDxkaXYgY2xhc3M9Imt2cyI+CiAgICAgIDxkaXYgY2xhc3M9ImtleSI+V2h5IG5vdzwvZGl2PjxkaXY+JHtsLndoeU5vd308L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ia2V5Ij5HZWFyPC9kaXY+PGRpdj4ke2wuZ2Vhcn08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ia2V5Ij5TZXR0aW5nczwvZGl2PjxkaXY+JHtsLnNldHRpbmdzfTwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJhY3Rpb25zIj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHNob3dtYXAiPlNob3cgb24gbWFwPC9idXR0b24+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBldGEiPkVUQTwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4gcm91dGUiPlJvdXRlPC9idXR0b24+CiAgICAgIDxhIGNsYXNzPSJidG4gb3BlbiIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPk9wZW4gKGFuY2hvcik8L2E+CiAgICAgIDxhIGNsYXNzPSJidG4gd2FsayIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPldhbGsgdG8gYW5jaG9yPC9hPgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJwaWxsc2V0IGFuY2hvcnMiIHJvbGU9InRhYmxpc3QiIGFyaWEtbGFiZWw9IkFuY2hvciBjaG9pY2VzIj48L2Rpdj4KICAgIDxkaXYgY2xhc3M9InBpbGxzZXQgbWljcm8iIHJvbGU9Imdyb3VwIiBhcmlhLWxhYmVsPSJNaWNyby1waW5zIj48L2Rpdj4KICAgIDxkZXRhaWxzPgogICAgICA8c3VtbWFyeT5EZXRhaWxzPC9zdW1tYXJ5PgogICAgICA8ZGl2IGNsYXNzPSJncmlkIj4KICAgICAgICA8ZGl2PgogICAgICAgICAgPHN0cm9uZz5QaW5zPC9zdHJvbmc+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJsaXN0Ij4keyhsLnBpbnN8fFtdKS5tYXAocD0+YDxkaXY+4oCiIDxlbT4ke3AudGl0bGV9PC9lbT4g4oCUICR7cC5kZXRhaWx9PC9kaXY+YCkuam9pbignJyl9PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxzdHJvbmc+U2hvdHM8L3N0cm9uZz4KICAgICAgICAgIDxkaXYgY2xhc3M9Imxpc3QiPiR7KGwuc2hvdHN8fFtdKS5tYXAocz0+YDxkaXY+4oCiIDxlbT4ke3MudGl0bGV9PC9lbT4g4oCUICR7cy5kZXRhaWx9PC9kaXY+YCkuam9pbignJyl9PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iZ3JpZC0yIj4KICAgICAgICAgIDxkaXY+PHN0cm9uZz5Nb29uPC9zdHJvbmc+PGRpdiBjbGFzcz0ibGlzdCIgZGF0YS1tb29uPjwvZGl2PjwvZGl2PgogICAgICAgICAgPGRpdj48c3Ryb25nPlRpZGVzPC9zdHJvbmc+PGRpdiBjbGFzcz0ibGlzdCIgZGF0YS10aWRlcz5CYXR0ZXJ5OiBzZWUgbGVmdCBwYW5lbDwvZGl2PjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXY+CiAgICAgICAgICA8c3Ryb25nPlJlZmVyZW5jZSBJbWFnZXM8L3N0cm9uZz4KICAgICAgICAgIDxkaXY+PGJ1dHRvbiBjbGFzcz0iYnRuIHJlZnMiPkxvYWQgcmVmZXJlbmNlIGltYWdlczwvYnV0dG9uPjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0icmVmLWdyaWQiIGRhdGEtcmVmcz48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Imxpc3QiIGRhdGEtcmVmcy1zdGF0dXM+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxzdHJvbmc+RWRpdCBBbmNob3JzPC9zdHJvbmc+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJsaXN0IiBkYXRhLWVkaXQtYW5jaG9ycz48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2RldGFpbHM+CiAgYDsKICBjb25zdCBhbmNJZHggPSBsLmFjdGl2ZUFuY2hvciB8fCAwOwogIGNvbnN0IGFuY1BpbGxzZXQgPSBkaXYucXVlcnlTZWxlY3RvcignLnBpbGxzZXQuYW5jaG9ycycpOwogIGwuYW5jaG9ycy5mb3JFYWNoKChhLCBpKT0+ewogICAgY29uc3QgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwogICAgYi5jbGFzc05hbWUgPSAncGlsbCcrKGk9PT1hbmNJZHg/JyBhY3RpdmUnOicnKTsKICAgIGIudGV4dENvbnRlbnQgPSBhLmxhYmVsIHx8IGBBbmNob3IgJHtpKzF9YDsKICAgIGIuc2V0QXR0cmlidXRlKCdyb2xlJywndGFiJyk7CiAgICBiLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICAgICAgbC5hY3RpdmVBbmNob3IgPSBpOwogICAgICBwZXJzaXN0QW5jaG9yRWRpdChsLmlkLCBsLmFuY2hvcnMsIGwuYWN0aXZlQW5jaG9yKTsKICAgICAgcmVuZGVyKCk7CiAgICB9KTsKICAgIGFuY1BpbGxzZXQuYXBwZW5kQ2hpbGQoYik7CiAgfSk7CiAgLy8gTWljcm8gcGluIGNoaXBzIChkZWVwIGxpbmtzIGZvciB3YWxraW5nIHRvIGVhY2ggbWljcm8gcGluKQogIGNvbnN0IG1pY3JvUGlsbHNldCA9IGRpdi5xdWVyeVNlbGVjdG9yKCcucGlsbHNldC5taWNybycpOwogIGNvbnN0IGFuYyA9IGwuYW5jaG9yc1thbmNJZHhdOwogIGNvbnN0IG1pY3JvcyA9IGNvbXB1dGVNaWNyb3MoYW5jLCBsLm1pY3JvfHxbXSk7CiAgbWljcm9zLmZvckVhY2goKG0sIGkpPT57CiAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgYS5jbGFzc05hbWUgPSAncGlsbCc7IGEudGV4dENvbnRlbnQgPSBtLnRpdGxlIHx8ICgnTWljcm8gJysoaSsxKSk7CiAgICBhLmhyZWYgPSBgaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9tYXBzL2Rpci8/YXBpPTEmZGVzdGluYXRpb249JHttLmxhdH0sJHttLmxvbn0mdHJhdmVsbW9kZT13YWxraW5nYDsKICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7IGEucmVsPSdub29wZW5lcic7CiAgICBtaWNyb1BpbGxzZXQuYXBwZW5kQ2hpbGQoYSk7CiAgfSk7CgogIC8vIEFjdGlvbnM6IE9wZW4gYW5jaG9yLCBXYWxrIHRvIGFuY2hvcgogIGNvbnN0IGFuY2hvciA9IGwuYW5jaG9yc1tsLmFjdGl2ZUFuY2hvcnx8MF0gfHwgbC5hbmNob3JzWzBdOwogIGRpdi5xdWVyeVNlbGVjdG9yKCcub3BlbicpLmhyZWYgPSBgaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9tYXBzL3NlYXJjaC8/YXBpPTEmcXVlcnk9JHthbmNob3IubGF0fSwke2FuY2hvci5sb259YDsKICBkaXYucXVlcnlTZWxlY3RvcignLndhbGsnKS5ocmVmID0gYGh0dHBzOi8vd3d3Lmdvb2dsZS5jb20vbWFwcy9kaXIvP2FwaT0xJmRlc3RpbmF0aW9uPSR7YW5jaG9yLmxhdH0sJHthbmNob3IubG9ufSZ0cmF2ZWxtb2RlPXdhbGtpbmdgOwoKICAvLyBTaG93IG9uIG1hcAogIGRpdi5xdWVyeVNlbGVjdG9yKCcuc2hvd21hcCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PiBlbmdpbmUgJiYgZW5naW5lLmZpdFRvKGwpKTsKICAvLyBFVEEKICBkaXYucXVlcnlTZWxlY3RvcignLmV0YScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCk9PnsKICAgIHRyeXsKICAgICAgY29uc3QgcG9zID0gYXdhaXQgZ2V0UG9zaXRpb24oKTsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgc2FmZUV0YShlbmdpbmUsIHBvcywgYW5jaG9yKTsKICAgICAgdG9hc3QoYEVUQTogJHtyZXMuZHVyYXRpb259IOKAoiAke3Jlcy5kaXN0YW5jZX1gKTsKICAgIH1jYXRjaChlKXsgdG9hc3QoJ0VUQSB1bmF2YWlsYWJsZTogJytlLm1lc3NhZ2UpOyB9CiAgfSk7CiAgLy8gUm91dGUKICBkaXYucXVlcnlTZWxlY3RvcignLnJvdXRlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKT0+ewogICAgdHJ5ewogICAgICBpZihzdGF0ZS5lbmdpbmUhPT0nZ29vZ2xlJykgeyB0b2FzdCgnUm91dGUgZHJhd2luZyByZXF1aXJlcyBHb29nbGUgbW9kZScpOyByZXR1cm47IH0KICAgICAgY29uc3QgcG9zID0gYXdhaXQgZ2V0UG9zaXRpb24oKTsKICAgICAgYXdhaXQgZW5naW5lLnJvdXRlKHtsYXQ6cG9zLmxhdCwgbG5nOnBvcy5sbmd9LCBhbmNob3IpOwogICAgICB0b2FzdCgnUm91dGUgZHJhd24nKTsKICAgIH1jYXRjaChlKXsgdG9hc3QoJ1JvdXRlIGZhaWxlZDogJytlLm1lc3NhZ2UpOyB9CiAgfSk7CgogIC8vIFBlci1jYXJkIG1vb24gc25pcHBldCAoZm9yIHRoZSBsb2NhdGlvbiBkYXkpCiAgY29uc3QgbW9vbkRpdiA9IGRpdi5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tb29uXScpOwogIGNvbnN0IGQgPSBuZXcgRGF0ZShsLmRheSsnVDEyOjAwOjAwJyk7CiAgY29uc3QgbW9vbiA9IGNhbGNNb29uVGltZXMoZCk7CiAgY29uc3QgaWxsdW0gPSBjYWxjTW9vbklsbHVtaW5hdGlvbihkKTsKICBtb29uRGl2LmlubmVySFRNTCA9IGBSaXNlOiAke2ZtdFRpbWUobW9vbi5yaXNlKX0gwrcgU2V0OiAke2ZtdFRpbWUobW9vbi5zZXQpfSDCtyBJbGx1bTogJHsoaWxsdW0uZnJhY3Rpb24qMTAwKS50b0ZpeGVkKDApfSVgOwoKICAvLyBSZWZlcmVuY2UgaW1hZ2VzIChsYXp5LCBQbGFjZXMpCiAgZGl2LnF1ZXJ5U2VsZWN0b3IoJy5yZWZzJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IGxvYWRSZWZlcmVuY2VzKGRpdiwgbCkpOwoKICAvLyBFZGl0IGFuY2hvcnMgVUkKICBjb25zdCBlZGl0RGl2ID0gZGl2LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWVkaXQtYW5jaG9yc10nKTsKICBsLmFuY2hvcnMuZm9yRWFjaCgoYSwgaSk9PnsKICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgcm93LmlubmVySFRNTCA9IGA8bGFiZWw+QW5jaG9yICR7aSsxfSBMYXQgPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAwMDEiIHZhbHVlPSIke2EubGF0fSI+PC9sYWJlbD4KICAgICAgICAgICAgICAgICAgICAgPGxhYmVsPiBMb24gPGlucHV0IHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMDAwMDEiIHZhbHVlPSIke2EubG9ufSI+PC9sYWJlbD5gOwogICAgY29uc3QgaW5wdXRzID0gcm93LnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0Jyk7CiAgICBpbnB1dHNbMF0uYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZXY9PnsgbC5hbmNob3JzW2ldLmxhdCA9IHBhcnNlRmxvYXQoZXYudGFyZ2V0LnZhbHVlKTsgcGVyc2lzdEFuY2hvckVkaXQobC5pZCwgbC5hbmNob3JzLCBsLmFjdGl2ZUFuY2hvcnx8MCk7IHJlbmRlcigpOyB9KTsKICAgIGlucHV0c1sxXS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBldj0+eyBsLmFuY2hvcnNbaV0ubG9uID0gcGFyc2VGbG9hdChldi50YXJnZXQudmFsdWUpOyBwZXJzaXN0QW5jaG9yRWRpdChsLmlkLCBsLmFuY2hvcnMsIGwuYWN0aXZlQW5jaG9yfHwwKTsgcmVuZGVyKCk7IH0pOwogICAgZWRpdERpdi5hcHBlbmRDaGlsZChyb3cpOwogIH0pOwoKICByZXR1cm4gZGl2Owp9CgpmdW5jdGlvbiBncm91cEJ5KGFyciwgZm4pewogIHJldHVybiBhcnIucmVkdWNlKChhY2MsIHgpPT57IGNvbnN0IGsgPSBmbih4KTsgKGFjY1trXT1hY2Nba118fFtdKS5wdXNoKHgpOyByZXR1cm4gYWNjOyB9LCB7fSk7Cn0KCmZ1bmN0aW9uIGNvbXB1dGVNaWNyb3MoYW5jaG9yLCBhcnIpewogIGNvbnN0IGxhdDAgPSBhbmNob3IubGF0ICogTWF0aC5QSS8xODA7CiAgcmV0dXJuIGFyci5tYXAobT0+ewogICAgY29uc3QgYnIgPSAobS5iZWFyaW5nfHwwKSAqIE1hdGguUEkvMTgwOwogICAgY29uc3QgZGxhdCA9IChtLnIgKiBNYXRoLmNvcyhicikpIC8gMTExMTExOwogICAgY29uc3QgZGxvbiA9IChtLnIgKiBNYXRoLnNpbihicikpIC8gKDExMTExMSAqIE1hdGguY29zKGxhdDApKTsKICAgIHJldHVybiB7IC4uLm0sIGxhdDogYW5jaG9yLmxhdCArIGRsYXQsIGxvbjogYW5jaG9yLmxvbiArIGRsb24gfTsKICB9KTsKfQoKZnVuY3Rpb24gdG9hc3QobXNnKXsKICBjb25zdCB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvYXN0Jyk7CiAgdC50ZXh0Q29udGVudCA9IG1zZzsgdC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRlJyk7CiAgc2V0VGltZW91dCgoKT0+IHQuY2xhc3NMaXN0LmFkZCgnaGlkZScpLCAzNTAwKTsKfQoKZnVuY3Rpb24gZ2V0UG9zaXRpb24oKXsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlcywgcmVqKT0+ewogICAgaWYoIW5hdmlnYXRvci5nZW9sb2NhdGlvbikgcmV0dXJuIHJlaihuZXcgRXJyb3IoJ0dlb2xvY2F0aW9uIG5vdCBzdXBwb3J0ZWQnKSk7CiAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKAogICAgICAocG9zKT0+IHJlcyh7bGF0OiBwb3MuY29vcmRzLmxhdGl0dWRlLCBsbmc6IHBvcy5jb29yZHMubG9uZ2l0dWRlfSksCiAgICAgIChlcnIpPT4gcmVqKG5ldyBFcnJvcignUGVybWlzc2lvbiBkZW5pZWQgb3IgdW5hdmFpbGFibGUnKSkKICAgICk7CiAgfSk7Cn0KYXN5bmMgZnVuY3Rpb24gc2FmZUV0YShlbmdpbmUsIG9yaWdpbiwgYW5jaG9yKXsKICB0cnl7CiAgICBpZihlbmdpbmUgJiYgZW5naW5lLmV0YSl7CiAgICAgIGNvbnN0IHIgPSBhd2FpdCBlbmdpbmUuZXRhKHtsYXQ6b3JpZ2luLmxhdCwgbG5nOm9yaWdpbi5sbmd9LCBhbmNob3IpOwogICAgICByZXR1cm4gcjsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcignRW5naW5lIG1pc3NpbmcgRVRBJyk7CiAgfWNhdGNoKGUpewogICAgLy8gZmFsbGJhY2sgYnkgc3RyYWlnaHQtbGluZQogICAgY29uc3QgZGttID0gaGF2ZXJzaW5lKG9yaWdpbi5sYXQsIG9yaWdpbi5sbmcsIGFuY2hvci5sYXQsIGFuY2hvci5sb24pOwogICAgY29uc3QgbWlucyA9IE1hdGgucm91bmQoZGttLzUqNjApOwogICAgcmV0dXJuIHsgZGlzdGFuY2U6IGAke2RrbS50b0ZpeGVkKDIpfSBrbSAoYXBwcm94KWAsIGR1cmF0aW9uOmAke21pbnN9IG1pbiAoYXBwcm94KWAgfTsKICB9Cn0KZnVuY3Rpb24gaGF2ZXJzaW5lKGxhdDEsIGxvbjEsIGxhdDIsIGxvbjIpewogIGNvbnN0IFIgPSA2MzcxOyAvLyBrbQogIGNvbnN0IGRMYXQgPSAobGF0Mi1sYXQxKSpNYXRoLlBJLzE4MDsKICBjb25zdCBkTG9uID0gKGxvbjItbG9uMSkqTWF0aC5QSS8xODA7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQvMikqKjIgKyBNYXRoLmNvcyhsYXQxKk1hdGguUEkvMTgwKSpNYXRoLmNvcyhsYXQyKk1hdGguUEkvMTgwKSpNYXRoLnNpbihkTG9uLzIpKioyOwogIGNvbnN0IGMgPSAyKk1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMS1hKSk7CiAgcmV0dXJuIFIqYzsKfQoKLy8gRXhwb3J0L0ltcG9ydApmdW5jdGlvbiBleHBvcnRDU1YoKXsKICBjb25zdCByb3dzID0gW1snaWQnLCduYW1lJywnZGF5JywnYmxvY2snLCdyYW5rJywnYmVhcmluZycsJ3doeU5vdycsJ2dlYXInLCdzZXR0aW5ncycsJ2FuY2hvckxhdCcsJ2FuY2hvckxvbiddXTsKICBNdXRhYmxlTG9jYXRpb25zLmZvckVhY2gobD0+ewogICAgY29uc3QgYSA9IGwuYW5jaG9yc1tsLmFjdGl2ZUFuY2hvcnx8MF0gfHwgbC5hbmNob3JzWzBdIHx8IHtsYXQ6JycsbG9uOicnfTsKICAgIHJvd3MucHVzaChbbC5pZCwgbC5uYW1lLCBsLmRheSwgbC5ibG9jaywgbC5yYW5rLCBsLmJlYXJpbmcsIGwud2h5Tm93LCBsLmdlYXIsIGwuc2V0dGluZ3MsIGEubGF0LCBhLmxvbl0pOwogIH0pOwogIGNvbnN0IGNzdiA9IHJvd3MubWFwKHI9PiByLm1hcCh4PT5gIiR7U3RyaW5nKHgpLnJlcGxhY2UoLyIvZywnIiInKX0iYCkuam9pbignLCcpKS5qb2luKCdcbicpOwogIGRvd25sb2FkKGNzdiwgJ3RleHQvY3N2JywgJ255Yy1waG90by1ndWlkZS5jc3YnKTsKfQpmdW5jdGlvbiBleHBvcnRLTUwoKXsKICBjb25zdCBwbGFjZW1hcmtzID0gW107CiAgZm9yKGNvbnN0IGwgb2YgTXV0YWJsZUxvY2F0aW9ucyl7CiAgICBjb25zdCBhID0gbC5hbmNob3JzW2wuYWN0aXZlQW5jaG9yfHwwXSB8fCBsLmFuY2hvcnNbMF07CiAgICBpZighYSkgY29udGludWU7CiAgICBwbGFjZW1hcmtzLnB1c2goYDxQbGFjZW1hcms+PG5hbWU+JHt4bWxFc2MobC5uYW1lKX08L25hbWU+PGRlc2NyaXB0aW9uPiR7eG1sRXNjKGwuYmxvY2spfSDigKIgIyR7bC5yYW5rfTwvZGVzY3JpcHRpb24+PFBvaW50Pjxjb29yZGluYXRlcz4ke2EubG9ufSwke2EubGF0fSwwPC9jb29yZGluYXRlcz48L1BvaW50PjwvUGxhY2VtYXJrPmApOwogICAgY29uc3QgbWljcm9zID0gY29tcHV0ZU1pY3JvcyhhLCBsLm1pY3JvfHxbXSk7CiAgICBmb3IoY29uc3QgbSBvZiBtaWNyb3MpewogICAgICBwbGFjZW1hcmtzLnB1c2goYDxQbGFjZW1hcms+PG5hbWU+JHt4bWxFc2MobC5uYW1lKX0g4oCUICR7eG1sRXNjKG0udGl0bGV8fCdNaWNybycpfTwvbmFtZT48UG9pbnQ+PGNvb3JkaW5hdGVzPiR7bS5sb259LCR7bS5sYXR9LDA8L2Nvb3JkaW5hdGVzPjwvUG9pbnQ+PC9QbGFjZW1hcms+YCk7CiAgICAgIC8vIHNob3J0IGFycm93IGxpbmUKICAgICAgY29uc3Qgb2ZmID0gb2Zmc2V0UG9pbnQoW20ubGF0LCBtLmxvbl0sIG0uYmVhcmluZywgMTUpOwogICAgICBwbGFjZW1hcmtzLnB1c2goYDxQbGFjZW1hcms+PG5hbWU+JHt4bWxFc2MobS50aXRsZXx8J0Fycm93Jyl9PC9uYW1lPjxMaW5lU3RyaW5nPjxjb29yZGluYXRlcz4ke20ubG9ufSwke20ubGF0fSwwICR7b2ZmWzFdfSwke29mZlswXX0sMDwvY29vcmRpbmF0ZXM+PC9MaW5lU3RyaW5nPjwvUGxhY2VtYXJrPmApOwogICAgfQogIH0KICBjb25zdCBrbWwgPSBgPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz5cbjxrbWwgeG1sbnM9Imh0dHA6Ly93d3cub3Blbmdpcy5uZXQva21sLzIuMiI+PERvY3VtZW50PiR7cGxhY2VtYXJrcy5qb2luKCcnKX08L0RvY3VtZW50Pjwva21sPmA7CiAgZG93bmxvYWQoa21sLCAnYXBwbGljYXRpb24vdm5kLmdvb2dsZS1lYXJ0aC5rbWwreG1sJywgJ255Yy1waG90by1ndWlkZS5rbWwnKTsKfQpmdW5jdGlvbiBleHBvcnRKU09OKCl7CiAgY29uc3Qgb3V0ID0geyBMT0NBVElPTlM6IE11dGFibGVMb2NhdGlvbnMsIHN0YXRlOiB7IGRheU1hcDogc3RhdGUuZGF5TWFwIH0gfTsKICBkb3dubG9hZChKU09OLnN0cmluZ2lmeShvdXQsIG51bGwsIDIpLCAnYXBwbGljYXRpb24vanNvbicsICdueWMtcGhvdG8tZ3VpZGUuanNvbicpOwp9CmFzeW5jIGZ1bmN0aW9uIGltcG9ydEpTT04oZSl7CiAgY29uc3QgZiA9IGUudGFyZ2V0LmZpbGVzPy5bMF07IGlmKCFmKSByZXR1cm47CiAgY29uc3QgdHh0ID0gYXdhaXQgZi50ZXh0KCk7CiAgdHJ5ewogICAgY29uc3Qgb2JqID0gSlNPTi5wYXJzZSh0eHQpOwogICAgaWYob2JqLkxPQ0FUSU9OUyAmJiBBcnJheS5pc0FycmF5KG9iai5MT0NBVElPTlMpKXsKICAgICAgTXV0YWJsZUxvY2F0aW9ucyA9IG9iai5MT0NBVElPTlM7CiAgICAgIC8vIHBlcnNpc3Qgb3ZlcnJpZGVzIHNvIHJlZnJlc2gga2VlcHMgdGhlIGVkaXRzCiAgICAgIGNvbnN0IG92ID0geyBhbmNob3JzOnt9LCBhY3RpdmVBbmNob3I6e30gfTsKICAgICAgZm9yKGNvbnN0IHJlYyBvZiBNdXRhYmxlTG9jYXRpb25zKXsKICAgICAgICBvdi5hbmNob3JzW3JlYy5pZF0gPSByZWMuYW5jaG9yczsKICAgICAgICBvdi5hY3RpdmVBbmNob3JbcmVjLmlkXSA9IHJlYy5hY3RpdmVBbmNob3J8fDA7CiAgICAgIH0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ0xPQ19PVkVSUklERVMnLCBKU09OLnN0cmluZ2lmeShvdikpOwogICAgfQogICAgaWYob2JqLnN0YXRlPy5kYXlNYXApewogICAgICBzdGF0ZS5kYXlNYXAgPSBvYmouc3RhdGUuZGF5TWFwOwogICAgICBpZihzdGF0ZS5kYXlNYXAuQSkgeyBzdGF0ZS5kYXlBID0gc3RhdGUuZGF5TWFwLkE7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkYXlBJykudmFsdWUgPSBzdGF0ZS5kYXlBOyB9CiAgICAgIGlmKHN0YXRlLmRheU1hcC5CKSB7IHN0YXRlLmRheUIgPSBzdGF0ZS5kYXlNYXAuQjsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RheUInKS52YWx1ZSA9IHN0YXRlLmRheUI7IH0KICAgIH0KICAgIHBhbmVscygpOyByZW5kZXIoKTsKICAgIHRvYXN0KCdKU09OIGltcG9ydGVkJyk7CiAgfWNhdGNoKGVycil7CiAgICB0b2FzdCgnSW1wb3J0IGZhaWxlZDogaW52YWxpZCBKU09OJyk7CiAgfQp9Ci8vIGhlbHBlcnMKZnVuY3Rpb24gZG93bmxvYWQoY29udGVudCwgbWltZSwgZmlsZW5hbWUpewogIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgYS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbY29udGVudF0sIHt0eXBlOm1pbWV9KSk7CiAgYS5kb3dubG9hZCA9IGZpbGVuYW1lOyBhLmNsaWNrKCk7CiAgc2V0VGltZW91dCgoKT0+IFVSTC5yZXZva2VPYmplY3RVUkwoYS5ocmVmKSwgMjAwMCk7Cn0KZnVuY3Rpb24geG1sRXNjKHMpeyByZXR1cm4gU3RyaW5nKHMpLnJlcGxhY2UoL1s8PiYnIl0vZywgYz0+KHsnPCc6JyZsdDsnLCc+JzonJmd0OycsJyYnOicmYW1wOycsIiciOicmYXBvczsnLCciJzonJnF1b3Q7J31bY10pKTsgfQpmdW5jdGlvbiBvZmZzZXRQb2ludChvcmlnaW5MYXRMb24sIGJlYXJpbmdEZWcsIG1ldGVycyl7CiAgY29uc3QgUiA9IDYzNzgxMzc7CiAgY29uc3QgW2xhdCwgbG9uXSA9IG9yaWdpbkxhdExvbjsKICBjb25zdCBiciA9IGJlYXJpbmdEZWcgKiBNYXRoLlBJLzE4MDsKICBjb25zdCBsYXQxID0gbGF0ICogTWF0aC5QSS8xODA7CiAgY29uc3QgbG9uMSA9IGxvbiAqIE1hdGguUEkvMTgwOwogIGNvbnN0IGxhdDIgPSBNYXRoLmFzaW4oTWF0aC5zaW4obGF0MSkqTWF0aC5jb3MobWV0ZXJzL1IpICsgTWF0aC5jb3MobGF0MSkqTWF0aC5zaW4obWV0ZXJzL1IpKk1hdGguY29zKGJyKSk7CiAgY29uc3QgbG9uMiA9IGxvbjEgKyBNYXRoLmF0YW4yKE1hdGguc2luKGJyKSpNYXRoLnNpbihtZXRlcnMvUikqTWF0aC5jb3MobGF0MSksIE1hdGguY29zKG1ldGVycy9SKS1NYXRoLnNpbihsYXQxKSpNYXRoLnNpbihsYXQyKSk7CiAgcmV0dXJuIFsgbGF0MioxODAvTWF0aC5QSSwgbG9uMioxODAvTWF0aC5QSSBdOwp9CgovLyBHb29nbGUgUGxhY2VzIChsYXp5KSDigJQgcmVxdWlyZXMgR29vZ2xlIGVuZ2luZSBsb2FkZWQKYXN5bmMgZnVuY3Rpb24gbG9hZFJlZmVyZW5jZXMoY2FyZEVsLCBsb2MpewogIGNvbnN0IHN0YXR1c0VsID0gY2FyZEVsLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXJlZnMtc3RhdHVzXScpOwogIGNvbnN0IGdyaWQgPSBjYXJkRWwucXVlcnlTZWxlY3RvcignW2RhdGEtcmVmc10nKTsKICBncmlkLmlubmVySFRNTD0nJzsgc3RhdHVzRWwudGV4dENvbnRlbnQ9Jyc7CiAgdHJ5ewogICAgaWYoISgnZ29vZ2xlJyBpbiBnbG9iYWxUaGlzKSB8fCAhZ29vZ2xlLm1hcHM/LnBsYWNlcyl7CiAgICAgIC8vIHRyeSBsb2FkaW5nIG1hcHMvcGxhY2VzIHF1aWNrbHkKICAgICAgY29uc3QgeyBsb2FkR29vZ2xlTWFwcyB9ID0gYXdhaXQgaW1wb3J0KCcuL2xpYi9nb29nbGVMb2FkZXIuanMnKTsKICAgICAgYXdhaXQgbG9hZEdvb2dsZU1hcHMoQ09ORklHLkdPT0dMRV9NQVBTX0FQSV9LRVksIFsncGxhY2VzJ10pOwogICAgfQogICAgaWYoIWdvb2dsZS5tYXBzPy5wbGFjZXMpeyB0aHJvdyBuZXcgRXJyb3IoJ1BsYWNlcyBub3QgYXZhaWxhYmxlJyk7IH0KICAgIGNvbnN0IGFuYyA9IGxvYy5hbmNob3JzW2xvYy5hY3RpdmVBbmNob3J8fDBdIHx8IGxvYy5hbmNob3JzWzBdOwogICAgY29uc3Qgc3ZjID0gbmV3IGdvb2dsZS5tYXBzLnBsYWNlcy5QbGFjZXNTZXJ2aWNlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgIGNvbnN0IHJlcSA9IHsKICAgICAgcXVlcnk6IChsb2MucGxhY2VRdWVyeSB8fCBsb2MubmFtZSksCiAgICAgIGxvY2F0aW9uOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKGFuYy5sYXQsIGFuYy5sb24pLAogICAgICByYWRpdXM6IDUwMAogICAgfTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpPT57CiAgICAgIHN2Yy50ZXh0U2VhcmNoKHJlcSwgKHJlc3VsdHMsIHN0YXR1cyk9PnsKICAgICAgICBpZihzdGF0dXMgIT09IGdvb2dsZS5tYXBzLnBsYWNlcy5QbGFjZXNTZXJ2aWNlU3RhdHVzLk9LIHx8ICFyZXN1bHRzPy5sZW5ndGgpIHJldHVybiByZWplY3QobmV3IEVycm9yKCdObyBpbWFnZXMgZm91bmQuJykpOwogICAgICAgIHJlc29sdmUocmVzdWx0cyk7CiAgICAgIH0pOwogICAgfSk7CiAgICBjb25zdCBwaG90b3MgPSByZXNbMF0ucGhvdG9zIHx8IFtdOwogICAgY29uc3QgaW1ncyA9IHBob3Rvcy5zbGljZSgwLDEyKS5tYXAocGg9PiBwaC5nZXRVcmwoe21heFdpZHRoOjY0MH0pKTsKICAgIGlmKCFpbWdzLmxlbmd0aCl7IHN0YXR1c0VsLnRleHRDb250ZW50ID0gJ05vIGltYWdlcyBmb3VuZC4nOyByZXR1cm47IH0KICAgIGZvcihjb25zdCB1IG9mIGltZ3MpewogICAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTsgaW1nLmxvYWRpbmc9J2xhenknOyBpbWcuZGVjb2Rpbmc9J2FzeW5jJzsKICAgICAgaW1nLnNyYyA9IHU7IGdyaWQuYXBwZW5kQ2hpbGQoaW1nKTsKICAgIH0KICB9Y2F0Y2goZSl7CiAgICBzdGF0dXNFbC50ZXh0Q29udGVudCA9ICdGYWlsZWQgdG8gbG9hZCByZWZlcmVuY2UgaW1hZ2VzLic7CiAgfQp9Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKT0+eyBpZihlLmtleT09PSdFc2NhcGUnKSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QnKS5jbGFzc0xpc3QuYWRkKCdoaWRlJyk7IH0pOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXQpOwo=", "config": "Ly8gY29uZmlnLmpzIOKAlCBydW50aW1lIGNvbmZpZ3VyYXRpb24gaGVscGVycwpleHBvcnQgY29uc3QgQ09ORklHID0gKCgpPT57CiAgY29uc3QgcGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhsb2NhdGlvbi5zZWFyY2gpOwogIGNvbnN0IGZyb21RdWVyeSA9IHBhcmFtcy5nZXQoJ2dtYXBzJykgfHwgcGFyYW1zLmdldCgna2V5Jyk7CiAgY29uc3QgZnJvbVN0b3JhZ2UgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnR09PR0xFX01BUFNfQVBJX0tFWScpOwogIGNvbnN0IGZyb21XaW5kb3cgPSAoZ2xvYmFsVGhpcy5FTlYgJiYgZ2xvYmFsVGhpcy5FTlYuR09PR0xFX01BUFNfQVBJX0tFWSkgfHwgJyc7CiAgY29uc3QgR09PR0xFX01BUFNfQVBJX0tFWSA9IGZyb21RdWVyeSB8fCBmcm9tU3RvcmFnZSB8fCBmcm9tV2luZG93IHx8ICcnOwogIHJldHVybiB7CiAgICBHT09HTEVfTUFQU19BUElfS0VZLAogICAgc2F2ZUtleShrKXsgaWYoaykgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ0dPT0dMRV9NQVBTX0FQSV9LRVknLCBrKTsgfSwKICB9Owp9KSgpOwo=", "data/locations": "Ly8gZGF0YS9sb2NhdGlvbnMuanMg4oCUIGxvYWQgbG9jYXRpb25zLmpzb24gYW5kIGV4cG9ydCBMT0NBVElPTlMgd2l0aCBsb2NhbCBvdmVycmlkZXMgbWVyZ2VkCmZ1bmN0aW9uIGRlZXBDbG9uZSh2KXsgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodikpOyB9CmFzeW5jIGZ1bmN0aW9uIGxvYWRMb2NhdGlvbnMoKXsKICB0cnl7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCgnLi9sb2NhdGlvbnMuanNvbicsIHtjYWNoZTonbm8tc3RvcmUnfSk7CiAgICBjb25zdCBiYXNlID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGNvbnN0IG92ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnTE9DX09WRVJSSURFUycpfHwne30nKTsKICAgIGlmKG92ICYmIG92LmFuY2hvcnMpewogICAgICAvLyBhbmNob3JzIG92ZXJyaWRlcyBrZXllZCBieSBpZCAtPiBhcnJheSBvZiBhbmNob3JzIG9yIHBhdGNoIGJ5IGluZGV4CiAgICAgIGZvcihjb25zdCByZWMgb2YgYmFzZSl7CiAgICAgICAgaWYob3YuYW5jaG9yc1tyZWMuaWRdKXsKICAgICAgICAgIHJlYy5hbmNob3JzID0gb3YuYW5jaG9yc1tyZWMuaWRdOwogICAgICAgIH0KICAgICAgICBpZihvdi5hY3RpdmVBbmNob3IgJiYgdHlwZW9mIG92LmFjdGl2ZUFuY2hvcltyZWMuaWRdID09PSAnbnVtYmVyJyl7CiAgICAgICAgICByZWMuYWN0aXZlQW5jaG9yID0gb3YuYWN0aXZlQW5jaG9yW3JlYy5pZF07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYmFzZTsKICB9Y2F0Y2goZSl7CiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCBsb2NhdGlvbnMuanNvbicsIGUpOwogICAgcmV0dXJuIFtdOwogIH0KfQovLyBUb3AtbGV2ZWwgYXdhaXQgaXMgc3VwcG9ydGVkIGluIG1vZGVybiBicm93c2VycyBmb3IgRVMgbW9kdWxlcwpleHBvcnQgY29uc3QgTE9DQVRJT05TID0gYXdhaXQgbG9hZExvY2F0aW9ucygpOwpleHBvcnQgZnVuY3Rpb24gcGVyc2lzdEFuY2hvckVkaXQoaWQsIGFuY2hvcnMsIGFjdGl2ZUlkeCl7CiAgY29uc3Qgb3YgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdMT0NfT1ZFUlJJREVTJyl8fCd7fScpOwogIG92LmFuY2hvcnMgPSBvdi5hbmNob3JzIHx8IHt9OwogIG92LmFuY2hvcnNbaWRdID0gYW5jaG9yczsKICBvdi5hY3RpdmVBbmNob3IgPSBvdi5hY3RpdmVBbmNob3IgfHwge307CiAgb3YuYWN0aXZlQW5jaG9yW2lkXSA9IGFjdGl2ZUlkeDsKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnTE9DX09WRVJSSURFUycsIEpTT04uc3RyaW5naWZ5KG92KSk7Cn0K", "lib/googleLoader": "Ly8gbGliL2dvb2dsZUxvYWRlci5qcyDigJQgaWRlbXBvdGVudCBQcm9taXNlLWJhc2VkIGxvYWRlciBmb3IgR29vZ2xlIE1hcHMgSlMgQVBJCmxldCBsb2FkUHJvbWlzZSA9IG51bGw7CmV4cG9ydCBmdW5jdGlvbiBsb2FkR29vZ2xlTWFwcyhrZXksIGxpYnJhcmllcz1bJ3BsYWNlcyddKXsKICBpZihnbG9iYWxUaGlzLmdvb2dsZSAmJiBnb29nbGUubWFwcykgcmV0dXJuIFByb21pc2UucmVzb2x2ZShnb29nbGUubWFwcyk7CiAgaWYobG9hZFByb21pc2UpIHJldHVybiBsb2FkUHJvbWlzZTsKICBpZigha2V5KSByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdNaXNzaW5nIEdPT0dMRV9NQVBTX0FQSV9LRVknKSk7CiAgY29uc3QgbGliUGFyYW0gPSBsaWJyYXJpZXMubGVuZ3RoID8gYCZsaWJyYXJpZXM9JHtlbmNvZGVVUklDb21wb25lbnQobGlicmFyaWVzLmpvaW4oJywnKSl9YCA6ICcnOwogIGxvYWRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+ewogICAgY29uc3QgY2IgPSAoKT0+IHJlc29sdmUoZ29vZ2xlLm1hcHMpOwogICAgY29uc3QgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgcy5zcmMgPSBgaHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2pzP2tleT0ke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfSR7bGliUGFyYW19YDsKICAgIHMuYXN5bmMgPSB0cnVlOwogICAgcy5vbmVycm9yID0gKCk9PiByZWplY3QobmV3IEVycm9yKCdHb29nbGUgTWFwcyBmYWlsZWQgdG8gbG9hZCcpKTsKICAgIHMub25sb2FkID0gY2I7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHMpOwogIH0pOwogIHJldHVybiBsb2FkUHJvbWlzZTsKfQoKCi8vIEFsaWFzZXMgZm9yIGNvbXBhdGliaWxpdHkKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRHb29nbGUoYXBpS2V5LCBsaWJzPVsncGxhY2VzJ10pIHsgcmV0dXJuIGxvYWRHb29nbGVNYXBzKGFwaUtleSwgbGlicyk7IH0KZXhwb3J0IGZ1bmN0aW9uIGhhc0dvb2dsZSgpeyByZXR1cm4gISEod2luZG93Lmdvb2dsZSAmJiB3aW5kb3cuZ29vZ2xlLm1hcHMpOyB9Cg==", "lib/sunmoon": "Ly8gbGliL3N1bm1vb24uanMg4oCUIGxpZ2h0d2VpZ2h0IHNvbGFyL2x1bmFyIGNhbGN1bGF0aW9ucyAoYXBwcm94aW1hdGUpCi8vIFJlZmVyZW5jZXM6IE5PQUEgc29sYXIgY2FsY3VsYXRpb25zIChzaW1wbGlmaWVkKTsgbHVuYXIgcGhhc2UgYXBwcm94aW1hdGlvbi4KCmNvbnN0IFBJID0gTWF0aC5QSTsKY29uc3QgUkFEID0gUEkvMTgwOwoKZnVuY3Rpb24gdG9KdWxpYW4oZGF0ZSl7CiAgcmV0dXJuIGRhdGUvODY0MDAwMDAgLSBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkvMTQ0MCArIDI0NDA1ODcuNTsKfQpmdW5jdGlvbiBmcm9tSnVsaWFuKGopewogIHJldHVybiBuZXcgRGF0ZSgoaiAtIDI0NDA1ODcuNSArIG5ldyBEYXRlKCkuZ2V0VGltZXpvbmVPZmZzZXQoKS8xNDQwKSo4NjQwMDAwMCk7Cn0KZnVuY3Rpb24gc29sYXJNZWFuQW5vbWFseShkKXsKICByZXR1cm4gUkFEICogKDM1Ny41MjkxICsgMC45ODU2MDAyOCAqIGQpOwp9CmZ1bmN0aW9uIGVjbGlwdGljTG9uZ2l0dWRlKE0pewogIGNvbnN0IEMgPSBSQUQqKDEuOTE0OCpNYXRoLnNpbihNKSArIDAuMDIqTWF0aC5zaW4oMipNKSArIDAuMDAwMypNYXRoLnNpbigzKk0pKTsKICBjb25zdCBQID0gUkFEKjEwMi45MzcyOwogIHJldHVybiBNICsgQyArIFAgKyBQSTsKfQpmdW5jdGlvbiBkZWNsaW5hdGlvbihMLCBiPTApewogIHJldHVybiBNYXRoLmFzaW4oTWF0aC5zaW4oYikqTWF0aC5jb3MoUkFEKjIzLjQzOTcpICsgTWF0aC5jb3MoYikqTWF0aC5zaW4oUkFEKjIzLjQzOTcpKk1hdGguc2luKEwpKTsKfQpmdW5jdGlvbiByaWdodEFzY2Vuc2lvbihMLCBiPTApewogIHJldHVybiBNYXRoLmF0YW4yKE1hdGguc2luKEwpKk1hdGguY29zKFJBRCoyMy40Mzk3KSAtIE1hdGgudGFuKGIpKk1hdGguc2luKFJBRCoyMy40Mzk3KSwgTWF0aC5jb3MoTCkpOwp9CmZ1bmN0aW9uIHNpZGVyZWFsVGltZShkLCBsdyl7CiAgcmV0dXJuIFJBRCAqICgyODAuMTYgKyAzNjAuOTg1NjIzNSAqIGQpIC0gbHc7Cn0KZnVuY3Rpb24gaG91ckFuZ2xlKGgsIHBoaSwgZGVjKXsKICByZXR1cm4gTWF0aC5hY29zKChNYXRoLnNpbihoKSAtIE1hdGguc2luKHBoaSkqTWF0aC5zaW4oZGVjKSkgLyAoTWF0aC5jb3MocGhpKSpNYXRoLmNvcyhkZWMpKSk7Cn0KCmZ1bmN0aW9uIGp1bGlhbkN5Y2xlKGQsIGx3KXsgcmV0dXJuIE1hdGgucm91bmQoZCAtIDAuMDAwOSAtIGx3LygyKlBJKSk7IH0KZnVuY3Rpb24gYXBwcm94VHJhbnNpdChIdCwgbHcsIG4peyByZXR1cm4gMC4wMDA5ICsgKEh0ICsgbHcpLygyKlBJKSArIG47IH0KZnVuY3Rpb24gc29sYXJUcmFuc2l0SihkcywgTSwgTCl7IHJldHVybiAyNDUxNTQ1LjUgKyBkcyArIDAuMDA1MypNYXRoLnNpbihNKSAtIDAuMDA2OSpNYXRoLnNpbigyKkwpOyB9CgpmdW5jdGlvbiBnZXRTZXRKKGgsIGx3LCBwaGksIGRlYywgbiwgTSwgTCl7CiAgY29uc3QgdyA9IGhvdXJBbmdsZShoLCBwaGksIGRlYyk7CiAgY29uc3QgYSA9IGFwcHJveFRyYW5zaXQodywgbHcsIG4pOwogIHJldHVybiBzb2xhclRyYW5zaXRKKGEsIE0sIEwpOwp9CgovLyBoMCB2YWx1ZXMgZm9yIHZhcmlvdXMgdHdpbGlnaHQgcGhhc2VzCmNvbnN0IEowID0gMC4wMDA5Owpjb25zdCBoMCA9IHsKICBzdW5yaXNlOiAtMC44MzMgKiBSQUQsCiAgY2l2aWw6IC02ICogUkFELAogIC8vIG5hdXRpY2FsOiAtMTIgKiBSQUQsCiAgLy8gYXN0cm86IC0xOCAqIFJBRAp9OwoKZXhwb3J0IGZ1bmN0aW9uIGNhbGNTdW5UaW1lcyhkYXRlLCBsYXQ9NDAuNzU4LCBsb249LTczLjk4NTUpewogIGNvbnN0IGx3ID0gUkFEICogLWxvbjsKICBjb25zdCBwaGkgPSBSQUQgKiBsYXQ7CiAgY29uc3QgZCA9IHRvSnVsaWFuKG5ldyBEYXRlKERhdGUuVVRDKGRhdGUuZ2V0RnVsbFllYXIoKSwgZGF0ZS5nZXRNb250aCgpLCBkYXRlLmdldERhdGUoKSkpKSAtIDI0NTE1NDU7CiAgY29uc3QgbiA9IGp1bGlhbkN5Y2xlKGQsIGx3KTsKICBjb25zdCBkcyA9IGFwcHJveFRyYW5zaXQoMCwgbHcsIG4pOwogIGNvbnN0IE0gPSBzb2xhck1lYW5Bbm9tYWx5KGRzKTsKICBjb25zdCBMID0gZWNsaXB0aWNMb25naXR1ZGUoTSk7CiAgY29uc3QgZGVjID0gZGVjbGluYXRpb24oTCwgMCk7CiAgY29uc3QgSm5vb24gPSBzb2xhclRyYW5zaXRKKGRzLCBNLCBMKTsKCiAgZnVuY3Rpb24gY29tcHV0ZShoKXsKICAgIGNvbnN0IEpzZXQgPSBnZXRTZXRKKGgsIGx3LCBwaGksIGRlYywgbiwgTSwgTCk7CiAgICBjb25zdCBKcmlzZSA9IEpub29uIC0gKEpzZXQgLSBKbm9vbik7CiAgICByZXR1cm4geyByaXNlOiBmcm9tSnVsaWFuKEpyaXNlKSwgc2V0OiBmcm9tSnVsaWFuKEpzZXQpIH07CiAgfQogIGNvbnN0IHN1biA9IGNvbXB1dGUoaDAuc3VucmlzZSk7CiAgY29uc3QgY2l2aWwgPSBjb21wdXRlKGgwLmNpdmlsKTsKCiAgcmV0dXJuIHsKICAgIHNvbGFyTm9vbjogZnJvbUp1bGlhbihKbm9vbiksCiAgICBzdW5yaXNlOiBzdW4ucmlzZSwKICAgIHN1bnNldDogc3VuLnNldCwKICAgIGNpdmlsRGF3bjogY2l2aWwucmlzZSwKICAgIGNpdmlsRHVzazogY2l2aWwuc2V0CiAgfTsKfQoKLy8gTW9vbiBwaGFzZSBmcmFjdGlvbiBhcHByb3hpbWF0aW9uIGFuZCByaXNlL3NldCAoY29hcnNlKQpleHBvcnQgZnVuY3Rpb24gY2FsY01vb25JbGx1bWluYXRpb24oZGF0ZSl7CiAgY29uc3QgbHAgPSBSQUQqMjE4LjMxNjsKICBjb25zdCBNID0gUkFEKjEzNC45NjM7CiAgY29uc3QgTXAgPSBSQUQqMzU3LjUyOTsKICBjb25zdCBEID0gUkFEKjI5Ny44NTA7CiAgY29uc3QgVCA9ICh0b0p1bGlhbihkYXRlKSAtIDI0NTE1NDUuMCkvMzY1MjU7CiAgY29uc3QgbCA9IGxwICsgUkFEKig0ODEyNjcuODgxMypUKSArIFJBRCooNi4yODkqTWF0aC5zaW4oTSkpOwogIGNvbnN0IGRtID0gbCAtIGxwOwogIC8vIGZyYWN0aW9uIGlsbHVtaW5hdGVkCiAgY29uc3QgayA9ICgxIC0gTWF0aC5jb3MoZG0pKSAvIDI7CiAgcmV0dXJuIHsgZnJhY3Rpb246IGsgfTsKfQoKLy8gVmVyeSByb3VnaCBtb29ucmlzZS9zZXQgdXNpbmcgc2ltcGxpZmllZCBhbGdvcml0aG07IG1heSByZXR1cm4gbnVsbCBmb3IgcG9sYXIgb3IgZWRnZSBjYXNlcy4KZXhwb3J0IGZ1bmN0aW9uIGNhbGNNb29uVGltZXMoZGF0ZSwgbGF0PTQwLjc1OCwgbG9uPS03My45ODU1KXsKICAvLyBVc2UgYSBzaW1wbGUgc3RlcC1zZWFyY2ggb3ZlciB0aGUgZGF5IHRvIGRldGVjdCBhbHRpdHVkZSBjcm9zc2luZyB6ZXJvCiAgY29uc3QgdGltZXMgPSBbXTsKICBjb25zdCBiYXNlID0gbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCksIGRhdGUuZ2V0RGF0ZSgpKTsKICBsZXQgbGFzdEFsdCA9IG51bGwsIGxhc3RUaW1lID0gbnVsbDsKICBmb3IobGV0IGg9MDsgaDw9MjQ7IGgrPTAuNSl7CiAgICBjb25zdCB0ID0gbmV3IERhdGUoYmFzZS5nZXRGdWxsWWVhcigpLCBiYXNlLmdldE1vbnRoKCksIGJhc2UuZ2V0RGF0ZSgpLCBoKTsKICAgIGNvbnN0IGFsdCA9IG1vb25BbHRpdHVkZSh0LCBsYXQsIGxvbik7CiAgICBpZihsYXN0QWx0IT09bnVsbCl7CiAgICAgIGlmKChsYXN0QWx0PDAgJiYgYWx0Pj0wKSB8fCAobGFzdEFsdD4wICYmIGFsdDw9MCkpewogICAgICAgIC8vIGxpbmVhciBpbnRlcnBvbGF0ZQogICAgICAgIGNvbnN0IGZyYWMgPSBNYXRoLmFicyhsYXN0QWx0KSAvIChNYXRoLmFicyhhbHQpICsgTWF0aC5hYnMobGFzdEFsdCkpOwogICAgICAgIGNvbnN0IGV2ZW50VGltZSA9IG5ldyBEYXRlKGxhc3RUaW1lLmdldFRpbWUoKSArICh0IC0gbGFzdFRpbWUpKmZyYWMpOwogICAgICAgIHRpbWVzLnB1c2goe3RpbWU6IGV2ZW50VGltZSwgdHlwZTogbGFzdEFsdDwwID8gJ3Jpc2UnIDogJ3NldCd9KTsKICAgICAgfQogICAgfQogICAgbGFzdEFsdCA9IGFsdDsgbGFzdFRpbWUgPSB0OwogIH0KICBjb25zdCByaXNlID0gdGltZXMuZmluZCh4PT54LnR5cGU9PT0ncmlzZScpOwogIGNvbnN0IHNldCA9IHRpbWVzLmZpbmQoeD0+eC50eXBlPT09J3NldCcpOwogIHJldHVybiB7IHJpc2U6IHJpc2U/LnRpbWUgfHwgbnVsbCwgc2V0OiBzZXQ/LnRpbWUgfHwgbnVsbCB9Owp9CgovLyBIZWxwZXI6IGFwcHJveGltYXRlIG1vb24gYWx0aXR1ZGUgKHJhZGlhbnMpIHVzaW5nIHNpbXBsaWZpZWQgbW9kZWwKZnVuY3Rpb24gbW9vbkNvb3JkcyhkKXsKICAvLyBiYXNlZCBvbiBzaW1wbGlmaWVkIGFsZ29yaXRobXMKICBjb25zdCBMID0gUkFEKigyMTguMzE2ICsgMTMuMTc2Mzk2ICogZCk7CiAgY29uc3QgTSA9IFJBRCooMTM0Ljk2MyArIDEzLjA2NDk5MyAqIGQpOwogIGNvbnN0IEYgPSBSQUQqKDkzLjI3MiArIDEzLjIyOTM1MCAqIGQpOwogIGNvbnN0IGxvbiA9IEwgKyBSQUQqNi4yODkgKiBNYXRoLnNpbihNKTsKICBjb25zdCBsYXQgPSBSQUQqNS4xMjggKiBNYXRoLnNpbihGKTsKICBjb25zdCBkaXN0ID0gMzg1MDAxIC0gMjA5MDUqTWF0aC5jb3MoTSk7CiAgcmV0dXJuIHsgbG9uLCBsYXQsIGRpc3QgfTsKfQpmdW5jdGlvbiBtb29uQWx0aXR1ZGUoZGF0ZSwgbGF0LCBsb24pewogIGNvbnN0IGx3ID0gUkFEICogLWxvbiwgcGhpID0gUkFEICogbGF0OwogIGNvbnN0IGQgPSB0b0p1bGlhbihkYXRlKSAtIDI0NTE1NDU7CiAgY29uc3QgbSA9IG1vb25Db29yZHMoZCk7CiAgY29uc3QgSCA9IHNpZGVyZWFsVGltZShkLCBsdykgLSBtLmxvbjsKICBjb25zdCBoID0gTWF0aC5hc2luKE1hdGguc2luKHBoaSkqTWF0aC5zaW4obS5sYXQpICsgTWF0aC5jb3MocGhpKSpNYXRoLmNvcyhtLmxhdCkqTWF0aC5jb3MoSCkpOwogIHJldHVybiBoOyAvLyByYWRpYW5zCn0KCmV4cG9ydCBmdW5jdGlvbiBmbXRUaW1lKGQpewogIGlmKCFkKSByZXR1cm4gJ+KAlCc7CiAgdHJ5ewogICAgcmV0dXJuIG5ldyBJbnRsLkRhdGVUaW1lRm9ybWF0KFtdLCB7aG91cjonMi1kaWdpdCcsIG1pbnV0ZTonMi1kaWdpdCd9KS5mb3JtYXQoZCk7CiAgfWNhdGNoKGUpewogICAgcmV0dXJuIGQudG9Mb2NhbGVUaW1lU3RyaW5nKCk7CiAgfQp9CgoKLy8gQWxpYXMgZXhwb3J0cyBmb3IgY29tcGF0aWJpbGl0eQpleHBvcnQgeyBjb21wdXRlU3VuVGltZXMgYXMgY2FsY1N1blRpbWVzLCBjb21wdXRlTW9vblRpbWVzIGFzIGNhbGNNb29uVGltZXMsIGNvbXB1dGVNb29uSWxsdW1pbmF0aW9uIGFzIGNhbGNNb29uSWxsdW1pbmF0aW9uIH07Cg==", "map-google": "Ly8gbWFwLWdvb2dsZS5qcyDigJQgR29vZ2xlIE1hcHMgZW5naW5lCmltcG9ydCB7IGxvYWRHb29nbGVNYXBzIH0gZnJvbSAnLi9saWIvZ29vZ2xlTG9hZGVyLmpzJzsKaW1wb3J0IHsgQ09ORklHIH0gZnJvbSAnLi9jb25maWcuanMnOwoKY29uc3QgYmxvY2tDb2xvcnMgPSB7CiAgJ01vcm5pbmcnOiAnI2ZmYjg0ZCcsCiAgJ0FmdGVybm9vbic6ICcjNGRkMmE0JywKICAnRXZlbmluZyc6ICcjOGE3ZGZmJywKICAnTmlnaHQnOiAnI2ZmNmI5YScKfTsKCmV4cG9ydCBjbGFzcyBHb29nbGVFbmdpbmUgewogIGNvbnN0cnVjdG9yKGNvbnRhaW5lcklkPSdtYXAtZ29vZ2xlJyl7CiAgICB0aGlzLmNvbnRhaW5lcklkID0gY29udGFpbmVySWQ7CiAgICB0aGlzLm1hcCA9IG51bGw7CiAgICB0aGlzLmxheWVycyA9IHsgbWFya2VyczogW10sIGxpbmVzOiBbXSwgcm91dGU6IG51bGwgfTsKICAgIHRoaXMuZGlyZWN0aW9ucyA9IG51bGw7CiAgfQogIGFzeW5jIGluaXQoY2VudGVyPXtsYXQ6NDAuNzU4LCBsbmc6LTczLjk4NTV9LCB6b29tPTEyKXsKICAgIGNvbnN0IGdtYXBzID0gYXdhaXQgbG9hZEdvb2dsZU1hcHMoQ09ORklHLkdPT0dMRV9NQVBTX0FQSV9LRVksIFsncGxhY2VzJ10pOwogICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmNvbnRhaW5lcklkKTsKICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgdGhpcy5tYXAgPSBuZXcgZ21hcHMuTWFwKGVsLCB7IGNlbnRlciwgem9vbSwgbWFwVHlwZUNvbnRyb2w6IGZhbHNlLCBzdHJlZXRWaWV3Q29udHJvbDogZmFsc2UgfSk7CiAgICB0aGlzLmNsZWFyKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xlYXIoKXsKICAgIGZvcihjb25zdCBtIG9mIHRoaXMubGF5ZXJzLm1hcmtlcnMpIG0uc2V0TWFwKG51bGwpOwogICAgZm9yKGNvbnN0IGwgb2YgdGhpcy5sYXllcnMubGluZXMpIGwuc2V0TWFwKG51bGwpOwogICAgdGhpcy5sYXllcnMubWFya2VycyA9IFtdOyB0aGlzLmxheWVycy5saW5lcyA9IFtdOwogICAgaWYodGhpcy5sYXllcnMucm91dGUpIHsgdGhpcy5sYXllcnMucm91dGUuc2V0TWFwKG51bGwpOyB0aGlzLmxheWVycy5yb3V0ZSA9IG51bGw7IH0KICB9CiAgcmVuZGVyKGxvY2F0aW9ucyl7CiAgICBpZighdGhpcy5tYXApIHJldHVybjsKICAgIHRoaXMuY2xlYXIoKTsKICAgIGNvbnN0IGdtYXBzID0gZ29vZ2xlLm1hcHM7CiAgICBmb3IoY29uc3QgbG9jIG9mIGxvY2F0aW9ucyl7CiAgICAgIGNvbnN0IGFuYyA9IGxvYy5hbmNob3JzW2xvYy5hY3RpdmVBbmNob3J8fDBdOwogICAgICBpZighYW5jKSBjb250aW51ZTsKICAgICAgY29uc3QgYW5jaG9yUG9zID0ge2xhdDogYW5jLmxhdCwgbG5nOiBhbmMubG9ufTsKICAgICAgY29uc3QgbWFya2VyID0gbmV3IGdtYXBzLk1hcmtlcih7CiAgICAgICAgcG9zaXRpb246IGFuY2hvclBvcywgbWFwOiB0aGlzLm1hcCwgdGl0bGU6IGxvYy5uYW1lLAogICAgICAgIGljb246IHsKICAgICAgICAgIHBhdGg6IGdtYXBzLlN5bWJvbFBhdGguQ0lSQ0xFLCBzY2FsZTogNiwKICAgICAgICAgIGZpbGxDb2xvcjogYmxvY2tDb2xvcnNbbG9jLmJsb2NrXSB8fCAnI2ZmZicsIGZpbGxPcGFjaXR5OiAxLAogICAgICAgICAgc3Ryb2tlQ29sb3I6ICcjMWIxZjJhJywgc3Ryb2tlV2VpZ2h0OiAxCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5sYXllcnMubWFya2Vycy5wdXNoKG1hcmtlcik7CiAgICAgIC8vIG1pY3JvLXBpbnMKICAgICAgY29uc3QgbWljcm9zID0gY29tcHV0ZU1pY3JvcyhhbmMsIGxvYy5taWNybyB8fCBbXSk7CiAgICAgIGZvcihjb25zdCBtIG9mIG1pY3Jvcyl7CiAgICAgICAgY29uc3QgbXAgPSBuZXcgZ21hcHMuTWFya2VyKHsKICAgICAgICAgIHBvc2l0aW9uOiB7bGF0Om0ubGF0LCBsbmc6bS5sb259LCBtYXA6IHRoaXMubWFwLCB0aXRsZTogbS50aXRsZSwKICAgICAgICAgIGljb246IHsKICAgICAgICAgICAgcGF0aDogZ21hcHMuU3ltYm9sUGF0aC5DSVJDTEUsIHNjYWxlOiA0LAogICAgICAgICAgICBmaWxsQ29sb3I6ICcjMWNkNGQ0JywgZmlsbE9wYWNpdHk6IDEsIHN0cm9rZUNvbG9yOiAnIzBiNScsIHN0cm9rZVdlaWdodDogMAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMubGF5ZXJzLm1hcmtlcnMucHVzaChtcCk7CiAgICAgICAgLy8gYXJyb3cKICAgICAgICBjb25zdCBhcnIgPSBuZXcgZ21hcHMuUG9seWxpbmUoewogICAgICAgICAgbWFwOiB0aGlzLm1hcCwgcGF0aDogWwogICAgICAgICAgICB7bGF0Om0ubGF0LCBsbmc6bS5sb259LAogICAgICAgICAgICBvZmZzZXRQb2ludCh7bGF0Om0ubGF0LCBsbmc6bS5sb259LCBtLmJlYXJpbmcsIDE1KQogICAgICAgICAgXSwgc3Ryb2tlQ29sb3I6JyMxMThhYjInLCBzdHJva2VPcGFjaXR5OjAuOSwgc3Ryb2tlV2VpZ2h0OjIKICAgICAgICB9KTsKICAgICAgICB0aGlzLmxheWVycy5saW5lcy5wdXNoKGFycik7CiAgICAgIH0KICAgIH0KICB9CiAgZml0VG8obG9jYXRpb24pewogICAgaWYoIXRoaXMubWFwKSByZXR1cm47CiAgICBjb25zdCBnbWFwcyA9IGdvb2dsZS5tYXBzOwogICAgY29uc3QgYW5jID0gbG9jYXRpb24uYW5jaG9yc1tsb2NhdGlvbi5hY3RpdmVBbmNob3J8fDBdOwogICAgaWYoIWFuYykgcmV0dXJuOwogICAgY29uc3QgYm91bmRzID0gbmV3IGdtYXBzLkxhdExuZ0JvdW5kcygpOwogICAgYm91bmRzLmV4dGVuZCh7bGF0OmFuYy5sYXQsIGxuZzphbmMubG9ufSk7CiAgICBjb25zdCBtaWNyb3MgPSBjb21wdXRlTWljcm9zKGFuYywgbG9jYXRpb24ubWljcm98fFtdKTsKICAgIGZvcihjb25zdCBtIG9mIG1pY3JvcykgYm91bmRzLmV4dGVuZCh7bGF0Om0ubGF0LCBsbmc6bS5sb259KTsKICAgIHRoaXMubWFwLmZpdEJvdW5kcyhib3VuZHMsIHtwYWRkaW5nOjQwfSk7CiAgfQogIGFzeW5jIGV0YShvcmlnaW4sIGFuY2hvcil7CiAgICBpZighKGdvb2dsZSAmJiBnb29nbGUubWFwcykpIHRocm93IG5ldyBFcnJvcignR29vZ2xlIG5vdCBsb2FkZWQnKTsKICAgIGNvbnN0IHN2YyA9IG5ldyBnb29nbGUubWFwcy5EaXN0YW5jZU1hdHJpeFNlcnZpY2UoKTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IHN2Yy5nZXREaXN0YW5jZU1hdHJpeCh7CiAgICAgIG9yaWdpbnM6IFtvcmlnaW5dLCBkZXN0aW5hdGlvbnM6IFt7bGF0OmFuY2hvci5sYXQsIGxuZzphbmNob3IubG9ufV0sCiAgICAgIHRyYXZlbE1vZGU6IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuV0FMS0lORywgdW5pdFN5c3RlbTogZ29vZ2xlLm1hcHMuVW5pdFN5c3RlbS5JTVBFUklBTAogICAgfSk7CiAgICBjb25zdCBjZWxsID0gcmVzLnJvd3M/LlswXT8uZWxlbWVudHM/LlswXTsKICAgIGlmKGNlbGwgJiYgY2VsbC5zdGF0dXM9PT0nT0snKXsKICAgICAgcmV0dXJuIHsgZGlzdGFuY2U6IGNlbGwuZGlzdGFuY2UudGV4dCwgZHVyYXRpb246IGNlbGwuZHVyYXRpb24udGV4dCB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKCdFVEEgdW5hdmFpbGFibGUnKTsKICB9CiAgYXN5bmMgcm91dGUob3JpZ2luLCBhbmNob3IpewogICAgY29uc3QgZ21hcHMgPSBnb29nbGUubWFwczsKICAgIGNvbnN0IGRpciA9IG5ldyBnbWFwcy5EaXJlY3Rpb25zU2VydmljZSgpOwogICAgY29uc3QgciA9IGF3YWl0IGRpci5yb3V0ZSh7CiAgICAgIG9yaWdpbiwgZGVzdGluYXRpb246IHtsYXQ6YW5jaG9yLmxhdCwgbG5nOmFuY2hvci5sb259LAogICAgICB0cmF2ZWxNb2RlOiBnbWFwcy5UcmF2ZWxNb2RlLldBTEtJTkcKICAgIH0pOwogICAgY29uc3QgcGF0aCA9IHIucm91dGVzWzBdLm92ZXJ2aWV3X3BhdGgubWFwKHA9Pih7bGF0OnAubGF0KCksIGxuZzpwLmxuZygpfSkpOwogICAgaWYodGhpcy5sYXllcnMucm91dGUpIHsgdGhpcy5sYXllcnMucm91dGUuc2V0TWFwKG51bGwpOyB0aGlzLmxheWVycy5yb3V0ZSA9IG51bGw7IH0KICAgIHRoaXMubGF5ZXJzLnJvdXRlID0gbmV3IGdtYXBzLlBvbHlsaW5lKHsgbWFwOnRoaXMubWFwLCBwYXRoLCBzdHJva2VDb2xvcjonI2ZmNWI1YicsIHN0cm9rZU9wYWNpdHk6MC45LCBzdHJva2VXZWlnaHQ6NCB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KfQoKZnVuY3Rpb24gY29tcHV0ZU1pY3JvcyhhbmNob3IsIGFycil7CiAgY29uc3QgbGF0MCA9IGFuY2hvci5sYXQgKiBNYXRoLlBJLzE4MDsKICByZXR1cm4gYXJyLm1hcChtPT57CiAgICBjb25zdCBiciA9IChtLmJlYXJpbmd8fDApICogTWF0aC5QSS8xODA7CiAgICBjb25zdCBkbGF0ID0gKG0uciAqIE1hdGguY29zKGJyKSkgLyAxMTExMTE7CiAgICBjb25zdCBkbG9uID0gKG0uciAqIE1hdGguc2luKGJyKSkgLyAoMTExMTExICogTWF0aC5jb3MobGF0MCkpOwogICAgcmV0dXJuIHsgLi4ubSwgbGF0OiBhbmNob3IubGF0ICsgZGxhdCwgbG9uOiBhbmNob3IubG9uICsgZGxvbiB9OwogIH0pOwp9CmZ1bmN0aW9uIG9mZnNldFBvaW50KG9yaWdpbiwgYmVhcmluZ0RlZywgbWV0ZXJzKXsKICBjb25zdCBSID0gNjM3ODEzNzsKICBjb25zdCBiciA9IGJlYXJpbmdEZWcgKiBNYXRoLlBJLzE4MDsKICBjb25zdCBsYXQxID0gb3JpZ2luLmxhdCAqIE1hdGguUEkvMTgwOwogIGNvbnN0IGxvbjEgPSBvcmlnaW4ubG5nICogTWF0aC5QSS8xODA7CiAgY29uc3QgbGF0MiA9IE1hdGguYXNpbihNYXRoLnNpbihsYXQxKSpNYXRoLmNvcyhtZXRlcnMvUikgKyBNYXRoLmNvcyhsYXQxKSpNYXRoLnNpbihtZXRlcnMvUikqTWF0aC5jb3MoYnIpKTsKICBjb25zdCBsb24yID0gbG9uMSArIE1hdGguYXRhbjIoTWF0aC5zaW4oYnIpKk1hdGguc2luKG1ldGVycy9SKSpNYXRoLmNvcyhsYXQxKSwgTWF0aC5jb3MobWV0ZXJzL1IpLU1hdGguc2luKGxhdDEpKk1hdGguc2luKGxhdDIpKTsKICByZXR1cm4geyBsYXQ6IGxhdDIqMTgwL01hdGguUEksIGxuZzogbG9uMioxODAvTWF0aC5QSSB9Owp9Cg==", "map-leaflet": "Ly8gbWFwLWxlYWZsZXQuanMg4oCUIExlYWZsZXQgZW5naW5lIChvZmZsaW5lLWZyaWVuZGx5KQpjb25zdCBMX0NTUyA9ICdodHRwczovL3VucGtnLmNvbS9sZWFmbGV0QDEuOS40L2Rpc3QvbGVhZmxldC5jc3MnOwpjb25zdCBMX0pTID0gJ2h0dHBzOi8vdW5wa2cuY29tL2xlYWZsZXRAMS45LjQvZGlzdC9sZWFmbGV0LmpzJzsKbGV0IGxlYWZsZXRQcm9taXNlID0gbnVsbDsKZnVuY3Rpb24gbG9hZExlYWZsZXQoKXsKICBpZihnbG9iYWxUaGlzLkwgJiYgTC5tYXApIHJldHVybiBQcm9taXNlLnJlc29sdmUoTCk7CiAgaWYobGVhZmxldFByb21pc2UpIHJldHVybiBsZWFmbGV0UHJvbWlzZTsKICBsZWFmbGV0UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCk9PnsKICAgIGNvbnN0IHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsgcy5zcmM9TF9KUzsgcy5hc3luYz10cnVlOwogICAgcy5vbmxvYWQ9KCk9PiByZXNvbHZlKEwpOwogICAgcy5vbmVycm9yPSgpPT4gcmVqZWN0KG5ldyBFcnJvcignTGVhZmxldCBmYWlsZWQgdG8gbG9hZCcpKTsKICAgIGNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7IGwucmVsPSdzdHlsZXNoZWV0JzsgbC5ocmVmPUxfQ1NTOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsKTsgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzKTsKICB9KTsKICByZXR1cm4gbGVhZmxldFByb21pc2U7Cn0KCmNvbnN0IGJsb2NrQ29sb3JzID0gewogICdNb3JuaW5nJzogJyNmZmI4NGQnLAogICdBZnRlcm5vb24nOiAnIzRkZDJhNCcsCiAgJ0V2ZW5pbmcnOiAnIzhhN2RmZicsCiAgJ05pZ2h0JzogJyNmZjZiOWEnCn07CgpleHBvcnQgY2xhc3MgTGVhZmxldEVuZ2luZSB7CiAgY29uc3RydWN0b3IoY29udGFpbmVySWQ9J21hcC1sZWFmbGV0Jyl7CiAgICB0aGlzLmNvbnRhaW5lcklkID0gY29udGFpbmVySWQ7CiAgICB0aGlzLm1hcCA9IG51bGw7CiAgICB0aGlzLmdyb3VwID0gbnVsbDsKICB9CiAgYXN5bmMgaW5pdChjZW50ZXI9WzQwLjc1OCwtNzMuOTg1NV0sIHpvb209MTIpewogICAgY29uc3QgTCA9IGF3YWl0IGxvYWRMZWFmbGV0KCk7CiAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuY29udGFpbmVySWQpOwogICAgZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICB0aGlzLm1hcCA9IEwubWFwKGVsKS5zZXRWaWV3KGNlbnRlciwgem9vbSk7CiAgICBMLnRpbGVMYXllcignaHR0cHM6Ly97c30udGlsZS5vcGVuc3RyZWV0bWFwLm9yZy97en0ve3h9L3t5fS5wbmcnLCB7IG1heFpvb206IDE5IH0pLmFkZFRvKHRoaXMubWFwKTsKICAgIHRoaXMuZ3JvdXAgPSBMLmxheWVyR3JvdXAoKS5hZGRUbyh0aGlzLm1hcCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xlYXIoKXsKICAgIGlmKHRoaXMuZ3JvdXApIHRoaXMuZ3JvdXAuY2xlYXJMYXllcnMoKTsKICB9CiAgcmVuZGVyKGxvY2F0aW9ucyl7CiAgICBpZighdGhpcy5tYXAgfHwgIXRoaXMuZ3JvdXApIHJldHVybjsKICAgIHRoaXMuY2xlYXIoKTsKICAgIGNvbnN0IEwgPSBnbG9iYWxUaGlzLkw7CiAgICBmb3IoY29uc3QgbG9jIG9mIGxvY2F0aW9ucyl7CiAgICAgIGNvbnN0IGFuYyA9IGxvYy5hbmNob3JzW2xvYy5hY3RpdmVBbmNob3J8fDBdOwogICAgICBpZighYW5jKSBjb250aW51ZTsKICAgICAgY29uc3QgYSA9IEwuY2lyY2xlTWFya2VyKFthbmMubGF0LCBhbmMubG9uXSwgeyByYWRpdXM6NiwgY29sb3I6JyMxYjFmMmEnLCB3ZWlnaHQ6MSwgZmlsbDp0cnVlLCBmaWxsT3BhY2l0eToxLCBmaWxsQ29sb3I6YmxvY2tDb2xvcnNbbG9jLmJsb2NrXXx8JyNmZmYnIH0pLmFkZFRvKHRoaXMuZ3JvdXApOwogICAgICBhLmJpbmRUb29sdGlwKGxvYy5uYW1lKTsKICAgICAgY29uc3QgbWljcm9zID0gY29tcHV0ZU1pY3JvcyhhbmMsIGxvYy5taWNyb3x8W10pOwogICAgICBmb3IoY29uc3QgbSBvZiBtaWNyb3MpewogICAgICAgIEwuY2lyY2xlTWFya2VyKFttLmxhdCwgbS5sb25dLCB7IHJhZGl1czo0LCBjb2xvcjonIzBiNScsIHdlaWdodDowLCBmaWxsOnRydWUsIGZpbGxPcGFjaXR5OjEsIGZpbGxDb2xvcjonIzFjZDRkNCcgfSkuYWRkVG8odGhpcy5ncm91cCk7CiAgICAgICAgY29uc3QgcDEgPSBbbS5sYXQsIG0ubG9uXTsKICAgICAgICBjb25zdCBwMiA9IG9mZnNldFBvaW50KFttLmxhdCwgbS5sb25dLCBtLmJlYXJpbmcsIDE1KTsKICAgICAgICBMLnBvbHlsaW5lKFtwMSwgcDJdLCB7IGNvbG9yOicjMTE4YWIyJywgd2VpZ2h0OjIsIG9wYWNpdHk6MC45IH0pLmFkZFRvKHRoaXMuZ3JvdXApOwogICAgICB9CiAgICB9CiAgfQogIGZpdFRvKGxvY2F0aW9uKXsKICAgIGNvbnN0IEwgPSBnbG9iYWxUaGlzLkw7CiAgICBjb25zdCBhbmMgPSBsb2NhdGlvbi5hbmNob3JzW2xvY2F0aW9uLmFjdGl2ZUFuY2hvcnx8MF07IGlmKCFhbmMpIHJldHVybjsKICAgIGNvbnN0IG1pY3JvcyA9IGNvbXB1dGVNaWNyb3MoYW5jLCBsb2NhdGlvbi5taWNyb3x8W10pOwogICAgY29uc3QgcHRzID0gW1thbmMubGF0LCBhbmMubG9uXSwgLi4ubWljcm9zLm1hcChtPT5bbS5sYXQsIG0ubG9uXSldOwogICAgY29uc3QgYiA9IEwubGF0TG5nQm91bmRzKHB0cyk7CiAgICB0aGlzLm1hcC5maXRCb3VuZHMoYiwgeyBwYWRkaW5nOls0MCw0MF0gfSk7CiAgfQogIGFzeW5jIGV0YShvcmlnaW4sIGFuY2hvcil7CiAgICAvLyBObyBEaXN0YW5jZSBNYXRyaXg7IGFwcHJveGltYXRlIGJ5IGhhdmVyc2luZSArIDUga20vaAogICAgY29uc3QgZCA9IGhhdmVyc2luZShvcmlnaW4ubGF0LCBvcmlnaW4ubG5nLCBhbmNob3IubGF0LCBhbmNob3IubG9uKTsgLy8ga20KICAgIGNvbnN0IGhycyA9IGQgLyA1OwogICAgY29uc3QgbWlucyA9IE1hdGgucm91bmQoaHJzKjYwKTsKICAgIHJldHVybiB7IGRpc3RhbmNlOiBgJHtkLnRvRml4ZWQoMil9IGttIChhcHByb3gpYCwgZHVyYXRpb246IGAke21pbnN9IG1pbiAoYXBwcm94KWAgfTsKICB9CiAgYXN5bmMgcm91dGUob3JpZ2luLCBhbmNob3IpewogICAgLy8gTm90IHN1cHBvcnRlZCBpbiBMZWFmbGV0LW9ubHkgbW9kZQogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKZnVuY3Rpb24gY29tcHV0ZU1pY3JvcyhhbmNob3IsIGFycil7CiAgY29uc3QgbGF0MCA9IGFuY2hvci5sYXQgKiBNYXRoLlBJLzE4MDsKICByZXR1cm4gYXJyLm1hcChtPT57CiAgICBjb25zdCBiciA9IChtLmJlYXJpbmd8fDApICogTWF0aC5QSS8xODA7CiAgICBjb25zdCBkbGF0ID0gKG0uciAqIE1hdGguY29zKGJyKSkgLyAxMTExMTE7CiAgICBjb25zdCBkbG9uID0gKG0uciAqIE1hdGguc2luKGJyKSkgLyAoMTExMTExICogTWF0aC5jb3MobGF0MCkpOwogICAgcmV0dXJuIHsgLi4ubSwgbGF0OiBhbmNob3IubGF0ICsgZGxhdCwgbG9uOiBhbmNob3IubG9uICsgZGxvbiB9OwogIH0pOwp9CmZ1bmN0aW9uIG9mZnNldFBvaW50KG9yaWdpbkxhdExvbiwgYmVhcmluZ0RlZywgbWV0ZXJzKXsKICBjb25zdCBSID0gNjM3ODEzNzsKICBjb25zdCBbbGF0LCBsb25dID0gb3JpZ2luTGF0TG9uOwogIGNvbnN0IGJyID0gYmVhcmluZ0RlZyAqIE1hdGguUEkvMTgwOwogIGNvbnN0IGxhdDEgPSBsYXQgKiBNYXRoLlBJLzE4MDsKICBjb25zdCBsb24xID0gbG9uICogTWF0aC5QSS8xODA7CiAgY29uc3QgbGF0MiA9IE1hdGguYXNpbihNYXRoLnNpbihsYXQxKSpNYXRoLmNvcyhtZXRlcnMvUikgKyBNYXRoLmNvcyhsYXQxKSpNYXRoLnNpbihtZXRlcnMvUikqTWF0aC5jb3MoYnIpKTsKICBjb25zdCBsb24yID0gbG9uMSArIE1hdGguYXRhbjIoTWF0aC5zaW4oYnIpKk1hdGguc2luKG1ldGVycy9SKSpNYXRoLmNvcyhsYXQxKSwgTWF0aC5jb3MobWV0ZXJzL1IpLU1hdGguc2luKGxhdDEpKk1hdGguc2luKGxhdDIpKTsKICByZXR1cm4gWyBsYXQyKjE4MC9NYXRoLlBJLCBsb24yKjE4MC9NYXRoLlBJIF07Cn0KZnVuY3Rpb24gaGF2ZXJzaW5lKGxhdDEsIGxvbjEsIGxhdDIsIGxvbjIpewogIGNvbnN0IFIgPSA2MzcxOyAvLyBrbQogIGNvbnN0IGRMYXQgPSAobGF0Mi1sYXQxKSpNYXRoLlBJLzE4MDsKICBjb25zdCBkTG9uID0gKGxvbjItbG9uMSkqTWF0aC5QSS8xODA7CiAgY29uc3QgYSA9IE1hdGguc2luKGRMYXQvMikqKjIgKyBNYXRoLmNvcyhsYXQxKk1hdGguUEkvMTgwKSpNYXRoLmNvcyhsYXQyKk1hdGguUEkvMTgwKSpNYXRoLnNpbihkTG9uLzIpKioyOwogIGNvbnN0IGMgPSAyKk1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMS1hKSk7CiAgcmV0dXJuIFIqYzsKfQo="};
const decode = b64 => new TextDecoder().decode(Uint8Array.from(atob(b64), c => c.charCodeAt(0)));
const urls = {}
// leaf modules
urls['config'] = URL.createObjectURL(new Blob([decode(B64["config"])], {type:'text/javascript'}));
urls['data/locations'] = URL.createObjectURL(new Blob([decode(B64["data/locations"])], {type:'text/javascript'}));
urls['lib/googleLoader'] = URL.createObjectURL(new Blob([decode(B64["lib/googleLoader"])], {type:'text/javascript'}));
urls['lib/sunmoon'] = URL.createObjectURL(new Blob([decode(B64["lib/sunmoon"])], {type:'text/javascript'}));
urls['map-leaflet'] = URL.createObjectURL(new Blob([decode(B64["map-leaflet"])], {type:'text/javascript'}));

// map-google (depends on lib/googleLoader)
let mg = decode(B64["map-google"])
  .replaceAll("from './lib/googleLoader.js'", `from '${urls['lib/googleLoader']}'`)
  .replaceAll('from "./lib/googleLoader.js"', `from '${urls['lib/googleLoader']}'`)
  .replaceAll("from 'lib/googleLoader'", `from '${urls['lib/googleLoader']}'`)
  .replaceAll('from "lib/googleLoader"', `from '${urls['lib/googleLoader']}'`);
urls['map-google'] = URL.createObjectURL(new Blob([mg], {type:'text/javascript'}));

// app with all imports rewritten
let appSrc = decode(B64["app"])
  .replaceAll("from './data/locations.js'", `from '${urls['data/locations']}'`)
  .replaceAll('from "./data/locations.js"', `from '${urls['data/locations']}'`)
  .replaceAll("from 'data/locations'", `from '${urls['data/locations']}'`)
  .replaceAll('from "data/locations"', `from '${urls['data/locations']}'`)
  .replaceAll("from './config.js'", `from '${urls['config']}'`)
  .replaceAll('from "./config.js"', `from '${urls['config']}'`)
  .replaceAll("from 'config'", `from '${urls['config']}'`)
  .replaceAll('from "config"', `from '${urls['config']}'`)
  .replaceAll("from './lib/sunmoon.js'", `from '${urls['lib/sunmoon']}'`)
  .replaceAll('from "./lib/sunmoon.js"', `from '${urls['lib/sunmoon']}'`)
  .replaceAll("from 'lib/sunmoon'", `from '${urls['lib/sunmoon']}'`)
  .replaceAll('from "lib/sunmoon"', `from '${urls['lib/sunmoon']}'`)
  .replaceAll("from './lib/googleLoader.js'", `from '${urls['lib/googleLoader']}'`)
  .replaceAll('from "./lib/googleLoader.js"', `from '${urls['lib/googleLoader']}'`)
  .replaceAll("from 'lib/googleLoader'", `from '${urls['lib/googleLoader']}'`)
  .replaceAll('from "lib/googleLoader"', `from '${urls['lib/googleLoader']}'`)
  .replaceAll("from './map-google.js'", `from '${urls['map-google']}'`)
  .replaceAll('from "./map-google.js"', `from '${urls['map-google']}'`)
  .replaceAll("from 'map-google'", `from '${urls['map-google']}'`)
  .replaceAll('from "map-google"', `from '${urls['map-google']}'`)
  .replaceAll("from './map-leaflet.js'", `from '${urls['map-leaflet']}'`)
  .replaceAll('from "./map-leaflet.js"', `from '${urls['map-leaflet']}'`)
  .replaceAll("from 'map-leaflet'", `from '${urls['map-leaflet']}'`)
  .replaceAll('from "map-leaflet"', `from '${urls['map-leaflet']}'`);

const appUrl = URL.createObjectURL(new Blob([appSrc], {type:'text/javascript'}));
import(appUrl);
</script>
</body>
</html>
